<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일상 습관 추적기</title>
    <meta name="description" content="프로작가를 향한 여정 - 매일 습관을 체크하고 관리하세요">
    
    <!-- PWA 매니페스트 -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuydvOyDgSDsirXqtIDssrbstpzquLAiLAogICJzaG9ydF9uYW1lIjogIuyKteqwgOy2nOq4sCIsCiAgImRlc2NyaXB0aW9uIjogIu2UhOuhnOyekOqwgOulvCDtlKXtlZwg7Jes7KCVIC0g66ek7J28IOyKteqwgOydhCDssrTtgaztlZjqs6Ag6rSA66as7ZWY7IS47JqUIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzNiODJmNiIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMMmQzTG01dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNE1EQWdPREF3SWlCbWFXeHNQU0lqUmpNNE9EQWlQZ29nSUNBOGNtVmpkQ0IzYVdSMGFEMGlPREF3SWlCb1pXbG5hSFE5SW1raU1URXpJalU5SWpreU1DSWdabWxzYkQwaVBpUmhiVGhpTWlJZ0x6NEtJQ0FnUEhCaGRHZ2daRDBpVFRJMElHUTJhRE00VUJGd1JGQXpPRkJ0TWpSb09UWjJPRWhuTXpKRGFEZ3lXMnd5UjNZNGFGOHpiVlJOZFVsMVNHeGhRMDVpTWtGRGRYVjRNWEJtWjNoRlpFNW9USFZzWVhSWFQzcCIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0K">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="습관추적기">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .hidden { display: none !important; }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 로딩 화면 -->
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-600">습관 추적기 로딩 중...</p>
            </div>
        </div>
    </div>

    <script>
        // 전역 상태
        let state = {
            currentDate: new Date(),
            habitData: JSON.parse(localStorage.getItem('habitData') || '{}'),
            isConnected: false,
            isLoading: false,
            error: null,
            sheetUrl: localStorage.getItem('sheetUrl') || '',
            showSetup: !localStorage.getItem('sheetUrl'),
            showInstallGuide: false,
            deferredPrompt: null,
            isInstallable: false
        };

        // 습관 목록
        const habits = [
            {
                id: 'novel',
                name: '소설 쓰기',
                priority: 1,
                description: '"5분만 써보자" 시작',
                target: '매일',
                color: 'bg-blue-500'
            },
            {
                id: 'exercise',
                name: '운동',
                priority: 2,
                description: '실내자전거 10분 + 스쿼트 5분',
                target: '매일 권장',
                color: 'bg-green-500'
            },
            {
                id: 'japanese',
                name: '일본어',
                priority: 2,
                description: '5분 기초 회화/출장 표현',
                target: '매일 권장',
                color: 'bg-yellow-500'
            },
            {
                id: 'blog',
                name: '블로그',
                priority: 3,
                description: '맛집/숙박/체험 리뷰',
                target: '주 3-4회',
                color: 'bg-purple-500'
            }
        ];

        // 유틸리티 함수들
        function getDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('ko-KR', options);
        }

        function isHabitDone(habitId) {
            const dateKey = getDateKey(state.currentDate);
            return state.habitData[dateKey]?.[habitId] || false;
        }

        function getWeekStats() {
            const stats = {};
            const today = new Date(state.currentDate);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = getDateKey(date);
                
                habits.forEach(habit => {
                    if (!stats[habit.id]) stats[habit.id] = 0;
                    if (state.habitData[dateKey]?.[habit.id]) {
                        stats[habit.id]++;
                    }
                });
            }
            
            return stats;
        }

        function getStreak(habitId) {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            
            while (true) {
                const dateKey = getDateKey(checkDate);
                if (state.habitData[dateKey]?.[habitId]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // 상태 업데이트 및 렌더링
        function setState(updates) {
            state = { ...state, ...updates };
            localStorage.setItem('habitData', JSON.stringify(state.habitData));
            if (state.sheetUrl) {
                localStorage.setItem('sheetUrl', state.sheetUrl);
            }
            render();
        }

        // 습관 토글
        function toggleHabit(habitId) {
            const dateKey = getDateKey(state.currentDate);
            const newData = { ...state.habitData };
            
            if (!newData[dateKey]) {
                newData[dateKey] = {};
            }
            
            newData[dateKey][habitId] = !newData[dateKey][habitId];
            setState({ habitData: newData });
        }

        // 날짜 변경
        function changeDate(days) {
            const newDate = new Date(state.currentDate);
            newDate.setDate(newDate.getDate() + days);
            setState({ currentDate: newDate });
        }

        // PWA 설치 처리
        function handleInstallClick() {
            if (!state.deferredPrompt) {
                setState({ showInstallGuide: true });
                return;
            }

            state.deferredPrompt.prompt().then((result) => {
                if (result.outcome === 'accepted') {
                    setState({ deferredPrompt: null, isInstallable: false });
                }
            });
        }

        // 구글 시트 연결
        function connectToSheet() {
            if (!state.sheetUrl) return;
            
            localStorage.setItem('sheetUrl', state.sheetUrl);
            setState({ showSetup: false, isConnected: true });
            loadDataFromSheet(state.sheetUrl);
        }

        // 구글 시트에서 데이터 로드
        async function loadDataFromSheet(url) {
            if (!url) return;
            
            setState({ isLoading: true, error: null });
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('시트에 접근할 수 없습니다');
                
                const csvText = await response.text();
                const rows = csvText.split('\n').slice(1); // 헤더 제외
                const data = {};
                
                rows.forEach(row => {
                    const cols = row.split(',');
                    if (cols.length >= 6) {
                        const date = cols[0]?.trim();
                        if (date) {
                            data[date] = {
                                novel: cols[1]?.trim() === 'TRUE',
                                exercise: cols[2]?.trim() === 'TRUE',
                                japanese: cols[3]?.trim() === 'TRUE',
                                blog: cols[4]?.trim() === 'TRUE'
                            };
                        }
                    }
                });
                
                setState({ habitData: data, isConnected: true, isLoading: false });
            } catch (err) {
                setState({ 
                    error: `데이터 로드 실패: ${err.message}`, 
                    isConnected: false, 
                    isLoading: false 
                });
            }
        }

        // 렌더링 함수
        function render() {
            const app = document.getElementById('app');
            
            if (state.showSetup) {
                app.innerHTML = renderSetupPage();
                return;
            }
            
            app.innerHTML = renderMainPage();
            
            // 아이콘 초기화
            lucide.createIcons();
        }

        // 설정 페이지 렌더링
        function renderSetupPage() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-lg shadow-md p-8">
                            <div class="text-center mb-6">
                                <i data-lucide="cloud" class="w-16 h-16 mx-auto text-blue-500 mb-4"></i>
                                <h1 class="text-2xl font-bold text-gray-800">구글 시트 연결</h1>
                                <p class="text-gray-600 mt-2">모든 기기에서 데이터를 동기화하세요</p>
                            </div>

                            <div class="space-y-6">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <h3 class="font-semibold text-blue-800 mb-2">📋 설정 방법</h3>
                                    <ol class="text-sm text-blue-700 space-y-1">
                                        <li>1. <a href="https://sheets.google.com" target="_blank" class="underline">구글 시트</a>에서 새 시트 생성</li>
                                        <li>2. A1: Date, B1: Novel, C1: Exercise, D1: Japanese, E1: Blog 입력</li>
                                        <li>3. 파일 → 공유 → "링크가 있는 모든 사용자" 설정</li>
                                        <li>4. 공유 URL 복사해서 아래에 붙여넣기</li>
                                        <li>5. URL 끝의 '/edit#gid=0'을 '/export?format=csv'로 변경</li>
                                    </ol>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        구글 시트 CSV URL
                                    </label>
                                    <input
                                        type="url"
                                        id="sheetUrl"
                                        value="${state.sheetUrl}"
                                        placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        oninput="state.sheetUrl = this.value"
                                    />
                                </div>

                                <div class="bg-yellow-50 rounded-lg p-4">
                                    <h4 class="font-medium text-yellow-800 mb-1">⚠️ 주의사항</h4>
                                    <p class="text-sm text-yellow-700">
                                        이 방법은 데이터를 읽기만 가능합니다. 체크한 내용은 로컬에만 저장되며, 
                                        다른 기기와 실시간 동기화되지 않습니다.
                                    </p>
                                </div>

                                <button
                                    onclick="connectToSheet()"
                                    class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2"
                                >
                                    <i data-lucide="cloud" class="w-5 h-5"></i>
                                    <span>연결하기</span>
                                </button>

                                <button
                                    onclick="setState({ showSetup: false })"
                                    class="w-full text-gray-500 hover:text-gray-700 py-2"
                                >
                                    오프라인으로 사용하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 메인 페이지 렌더링
        function renderMainPage() {
            const todayStats = getWeekStats();
            const completedToday = habits.filter(h => isHabitDone(h.id)).length;
            const totalHabits = habits.length;

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- 헤더 -->
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">📝 일상 습관 추적기</h1>
                            <p class="text-gray-600">프로작가를 향한 여정 🎯</p>
                            
                            <!-- 연결 상태 및 설치 버튼 -->
                            <div class="flex items-center justify-center space-x-4 mt-2">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 rounded-full ${state.isConnected ? 'bg-green-500' : 'bg-gray-400'}"></div>
                                    <span class="text-sm text-gray-600">
                                        ${state.isConnected ? '구글 시트 연결됨' : '오프라인 모드'}
                                    </span>
                                    <button
                                        onclick="setState({ showSetup: true })"
                                        class="text-xs text-blue-500 hover:text-blue-700 underline"
                                    >
                                        설정
                                    </button>
                                </div>
                                
                                <!-- PWA 설치 버튼 -->
                                <button
                                    onclick="handleInstallClick()"
                                    class="flex items-center space-x-1 text-xs bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition-colors"
                                >
                                    <i data-lucide="download" class="w-3 h-3"></i>
                                    <span>앱 설치</span>
                                </button>
                            </div>
                        </div>

                        ${state.error ? `
                        <!-- 오류 메시지 -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-center space-x-2">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                            <span class="text-red-700">${state.error}</span>
                            <button
                                onclick="setState({ error: null })"
                                class="ml-auto text-red-500 hover:text-red-700"
                            >
                                ✕
                            </button>
                        </div>
                        ` : ''}

                        <!-- 날짜 네비게이션 -->
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <button 
                                    onclick="changeDate(-1)"
                                    class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    ← 이전
                                </button>
                                <div class="text-center">
                                    <h2 class="text-xl font-semibold text-gray-800">${formatDate(state.currentDate)}</h2>
                                    <p class="text-sm text-gray-500">9월 1일부터 시작!</p>
                                </div>
                                <button 
                                    onclick="changeDate(1)"
                                    class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors ${state.currentDate >= new Date() ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${state.currentDate >= new Date() ? 'disabled' : ''}
                                >
                                    다음 →
                                </button>
                            </div>

                            <!-- 오늘의 진행상황 -->
                            <div class="flex items-center justify-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="target" class="w-5 h-5 text-blue-500"></i>
                                    <span class="text-sm font-medium">오늘 완료: ${completedToday}/${totalHabits}</span>
                                </div>
                                <div class="px-3 py-1 rounded-full text-sm font-medium ${
                                    completedToday === totalHabits ? 'bg-green-100 text-green-800' :
                                    completedToday >= 2 ? 'bg-yellow-100 text-yellow-800' :
                                    completedToday >= 1 ? 'bg-blue-100 text-blue-800' :
                                    'bg-gray-100 text-gray-800'
                                }">
                                    ${completedToday === totalHabits ? '완벽!' :
                                      completedToday >= 2 ? '훌륭!' :
                                      completedToday >= 1 ? '좋아요!' : '시작해보세요!'}
                                </div>
                                ${state.isLoading ? '<i data-lucide="loader" class="w-4 h-4 animate-spin text-blue-500"></i>' : ''}
                            </div>
                        </div>

                        <!-- 습관 체크리스트 -->
                        <div class="grid gap-4 mb-6">
                            ${habits.map((habit) => `
                                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-3 h-3 rounded-full ${habit.color}"></div>
                                            <div>
                                                <div class="flex items-center space-x-2">
                                                    <h3 class="text-lg font-semibold text-gray-800">${habit.name}</h3>
                                                    <span class="px-2 py-1 text-xs rounded-full ${
                                                        habit.priority === 1 ? 'bg-red-100 text-red-800' :
                                                        habit.priority === 2 ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-green-100 text-green-800'
                                                    }">
                                                        ${habit.priority === 1 ? '필수' : habit.priority === 2 ? '권장' : '선택'}
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-600">${habit.description}</p>
                                                <p class="text-xs text-gray-500">${habit.target}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-4">
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-gray-700">이번 주: ${todayStats[habit.id] || 0}/7</p>
                                                <p class="text-xs text-gray-500">연속: ${getStreak(habit.id)}일</p>
                                            </div>
                                            <button
                                                onclick="toggleHabit('${habit.id}')"
                                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 ${
                                                    isHabitDone(habit.id)
                                                        ? `${habit.color} text-white shadow-lg scale-105`
                                                        : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                                                }"
                                            >
                                                <i data-lucide="${isHabitDone(habit.id) ? 'check' : 'x'}" class="w-6 h-6"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- 통계 및 격려 메시지 -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                                이번 주 통계
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                ${habits.map((habit) => `
                                    <div class="text-center">
                                        <div class="w-16 h-16 rounded-full ${habit.color} text-white flex items-center justify-center mx-auto mb-2">
                                            <span class="text-xl font-bold">${todayStats[habit.id] || 0}</span>
                                        </div>
                                        <p class="text-sm font-medium text-gray-700">${habit.name}</p>
                                        <p class="text-xs text-gray-500">${Math.round(((todayStats[habit.id] || 0) / 7) * 100)}%</p>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- 격려 메시지 -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2">💪 격려의 한마디</h4>
                                <p class="text-sm text-gray-600">
                                    ${completedToday === totalHabits ? 
                                        "오늘 모든 습관을 완료했네요! 정말 대단해요. 이 페이스를 유지하면 한 달의 벽을 넘을 수 있을 거예요!" :
                                    completedToday >= 2 ?
                                        "좋은 진전이에요! 소설 쓰기만큼은 꼭 유지하면서 나머지도 차근차근 해나가세요." :
                                    completedToday >= 1 ?
                                        "시작이 반이에요! 특히 소설 쓰기를 했다면 오늘은 성공한 하루입니다." :
                                        "괜찮아요. '5분만 써보자'로 소설부터 시작해보세요. 작은 시작이 큰 변화를 만듭니다."}
                                </p>
                                <p class="text-xs text-gray-500 mt-2">
                                    💡 기억하세요: 완벽하지 않아도 지속하는 것이 핵심입니다!
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    ${state.showInstallGuide ? renderInstallGuideModal() : ''}
                </div>
            `;
        }

        // 설치 가이드 모달 렌더링
        function renderInstallGuideModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <div class="text-center mb-6">
                            <i data-lucide="smartphone" class="w-16 h-16 mx-auto text-blue-500 mb-4"></i>
                            <h2 class="text-xl font-bold text-gray-800">앱으로 설치하기</h2>
                            <p class="text-gray-600 mt-2">홈 화면에서 바로 접근하세요!</p>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h3 class="font-semibold text-blue-800 mb-2">📱 모바일 (Chrome/Safari)</h3>
                                <ol class="text-sm text-blue-700 space-y-1">
                                    <li>1. 브라우저 메뉴(⋮) 클릭</li>
                                    <li>2. "홈 화면에 추가" 선택</li>
                                    <li>3. "설치" 또는 "추가" 버튼 클릭</li>
                                </ol>
                            </div>

                            <div class="bg-green-50 rounded-lg p-4">
                                <h3 class="font-semibold text-green-800 mb-2">💻 PC (Chrome/Edge)</h3>
                                <ol class="text-sm text-green-700 space-y-1">
                                    <li>1. 주소창 오른쪽 설치 아이콘 클릭</li>
                                    <li>2. 또는 메뉴 → "앱 설치"</li>
                                    <li>3. "설치" 버튼 클릭</li>
                                </ol>
                            </div>

                            <div class="bg-yellow-50 rounded-lg p-4">
                                <h4 class="font-medium text-yellow-800 mb-1">✨ 설치 후 장점</h4>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>• 홈 화면에서 바로 실행</li>
                                    <li>• 오프라인에서도 사용 가능</li>
                                    <li>• 앱처럼 전체화면으로 실행</li>
                                    <li>• 푸시 알림 지원 (향후 추가)</li>
                                </ul>
                            </div>
                        </div>

                        <button
                            onclick="setState({ showInstallGuide: false })"
                            class="w-full mt-6 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300"
                        >
                            닫기
                        </button>
                    </div>
                </div>
            `;
        }

        // PWA 매니페스트 생성
        function createManifest() {
            const manifest = {
                name: "일상 습관 추적기",
                short_name: "습관추적기",
                description: "프로작가를 향한 여정 - 매일 습관을 체크하고 관리하세요",
                start_url: "./",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#3b82f6",
                orientation: "portrait",
                icons: [
                    {
                        src: "data:image/svg+xml;base64," + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" fill="#3b82f6">
                                <rect width="192" height="192" rx="20" fill="#f0f7ff"/>
                                <path d="M48 64h96v8H48zm0 24h96v8H48zm0 24h72v8H48z" fill="#3b82f6"/>
                                <circle cx="32" cy="68" r="4" fill="#10b981"/>
                                <circle cx="32" cy="92" r="4" fill="#f59e0b"/>
                                <circle cx="32" cy="116" r="4" fill="#8b5cf6"/>
                            </svg>
                        `),
                        sizes: "192x192",
                        type: "image/svg+xml"
                    }
                ]
            };

            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            
            const manifestLink = document.getElementById('manifest-link');
            manifestLink.href = manifestUrl;
        }

        // 서비스 워커 등록
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'habit-tracker-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/lucide@latest/dist/umd/lucide.js'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;
                
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('서비스 워커 등록 성공:', registration);
                    })
                    .catch(error => {
                        console.log('서비스 워커 등록 실패:', error);
                    });
            }
        }

        // PWA 설치 프롬프트 이벤트 리스너
        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                state.isInstallable = true;
            });

            window.addEventListener('appinstalled', () => {
                state.deferredPrompt = null;
                state.isInstallable = false;
                setState({ showInstallGuide: false });
            });
        }

        // 초기화
        function init() {
            createManifest();
            registerServiceWorker();
            setupPWA();
            
            // 초기 데이터 로드
            if (state.sheetUrl && !state.showSetup) {
                loadDataFromSheet(state.sheetUrl);
            }
            
            render();
        }

        // DOM 로드 완료 후 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>