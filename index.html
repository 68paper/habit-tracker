<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ìƒ ìŠµê´€ ì¶”ì ê¸°</title>
    <meta name="description" content="í”„ë¡œì‘ê°€ë¥¼ í–¥í•œ ì—¬ì • - ë§¤ì¼ ìŠµê´€ì„ ì²´í¬í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”">
    
    <!-- PWA ë§¤ë‹ˆí˜ìŠ¤íŠ¸ -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuydvOyDgSDsirXqtIDssrbstpzquLAiLAogICJzaG9ydF9uYW1lIjogIuyKteqwgOy2nOq4sCIsCiAgImRlc2NyaXB0aW9uIjogIu2UhOuhnOyekOqwgOulvCDtlKXtlZwg7Jes7KCVIC0g66ek7J28IOyKteqwgOydhCDssrTtgaztlZjqs6Ag6rSA66as7ZWY7IS47JqUIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzNiODJmNiIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMMmQzTG01dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNE1EQWdPREF3SWlCbWFXeHNQU0lqUmpNNE9EQWlQZ29nSUNBOGNtVmpkQ0IzYVdSMGFEMGlPREF3SWlCb1pXbG5hSFE5SW1raU1URXpJalU5SWpreU1DSWdabWxzYkQwaVBpUmhiVGhpTWlJZ0x6NEtJQ0FnUEhCaGRHZ2daRDBpVFRJMElHUTJhRE00VUJGd1JGQXpPRkJ0TWpSb09UWjJPRWhuTXpKRGFEZ3lXMnd5UjNZNGFGOHpiVlJOZFVsMVNHeGhRMDVpTWtGRGRYVjRNWEJtWjNoRlpFNW9USFZzWVhSWFQzcCIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0K">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ìŠµê´€ì¶”ì ê¸°">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .hidden { display: none !important; }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ë¡œë”© í™”ë©´ -->
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-600">ìŠµê´€ ì¶”ì ê¸° ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ
        let state = {
            currentDate: new Date(),
            habitData: JSON.parse(localStorage.getItem('habitData') || '{}'),
            isConnected: false,
            isLoading: false,
            error: null,
            sheetUrl: localStorage.getItem('sheetUrl') || '',
            showSetup: !localStorage.getItem('sheetUrl'),
            showInstallGuide: false,
            deferredPrompt: null,
            isInstallable: false
        };

        // ìŠµê´€ ëª©ë¡
        const habits = [
            {
                id: 'novel',
                name: 'ì†Œì„¤ ì“°ê¸°',
                priority: 1,
                description: '"5ë¶„ë§Œ ì¨ë³´ì" ì‹œì‘',
                target: 'ë§¤ì¼',
                color: 'bg-blue-500'
            },
            {
                id: 'exercise',
                name: 'ìš´ë™',
                priority: 2,
                description: 'ì‹¤ë‚´ìì „ê±° 10ë¶„ + ìŠ¤ì¿¼íŠ¸ 5ë¶„',
                target: 'ë§¤ì¼ ê¶Œì¥',
                color: 'bg-green-500'
            },
            {
                id: 'japanese',
                name: 'ì¼ë³¸ì–´',
                priority: 2,
                description: '5ë¶„ ê¸°ì´ˆ íšŒí™”/ì¶œì¥ í‘œí˜„',
                target: 'ë§¤ì¼ ê¶Œì¥',
                color: 'bg-yellow-500'
            },
            {
                id: 'blog',
                name: 'ë¸”ë¡œê·¸',
                priority: 3,
                description: 'ë§›ì§‘/ìˆ™ë°•/ì²´í—˜ ë¦¬ë·°',
                target: 'ì£¼ 3-4íšŒ',
                color: 'bg-purple-500'
            }
        ];

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('ko-KR', options);
        }

        function isHabitDone(habitId) {
            const dateKey = getDateKey(state.currentDate);
            return state.habitData[dateKey]?.[habitId] || false;
        }

        function getWeekStats() {
            const stats = {};
            const today = new Date(state.currentDate);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = getDateKey(date);
                
                habits.forEach(habit => {
                    if (!stats[habit.id]) stats[habit.id] = 0;
                    if (state.habitData[dateKey]?.[habit.id]) {
                        stats[habit.id]++;
                    }
                });
            }
            
            return stats;
        }

        function getStreak(habitId) {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            
            while (true) {
                const dateKey = getDateKey(checkDate);
                if (state.habitData[dateKey]?.[habitId]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë Œë”ë§
        function setState(updates) {
            state = { ...state, ...updates };
            localStorage.setItem('habitData', JSON.stringify(state.habitData));
            if (state.sheetUrl) {
                localStorage.setItem('sheetUrl', state.sheetUrl);
            }
            render();
        }

        // ìŠµê´€ í† ê¸€
        function toggleHabit(habitId) {
            const dateKey = getDateKey(state.currentDate);
            const newData = { ...state.habitData };
            
            if (!newData[dateKey]) {
                newData[dateKey] = {};
            }
            
            newData[dateKey][habitId] = !newData[dateKey][habitId];
            setState({ habitData: newData });
        }

        // ë‚ ì§œ ë³€ê²½
        function changeDate(days) {
            const newDate = new Date(state.currentDate);
            newDate.setDate(newDate.getDate() + days);
            setState({ currentDate: newDate });
        }

        // PWA ì„¤ì¹˜ ì²˜ë¦¬
        function handleInstallClick() {
            if (!state.deferredPrompt) {
                setState({ showInstallGuide: true });
                return;
            }

            state.deferredPrompt.prompt().then((result) => {
                if (result.outcome === 'accepted') {
                    setState({ deferredPrompt: null, isInstallable: false });
                }
            });
        }

        // êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°
        function connectToSheet() {
            if (!state.sheetUrl) return;
            
            localStorage.setItem('sheetUrl', state.sheetUrl);
            setState({ showSetup: false, isConnected: true });
            loadDataFromSheet(state.sheetUrl);
        }

        // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ
        async function loadDataFromSheet(url) {
            if (!url) return;
            
            setState({ isLoading: true, error: null });
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('ì‹œíŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                
                const csvText = await response.text();
                const rows = csvText.split('\n').slice(1); // í—¤ë” ì œì™¸
                const data = {};
                
                rows.forEach(row => {
                    const cols = row.split(',');
                    if (cols.length >= 6) {
                        const date = cols[0]?.trim();
                        if (date) {
                            data[date] = {
                                novel: cols[1]?.trim() === 'TRUE',
                                exercise: cols[2]?.trim() === 'TRUE',
                                japanese: cols[3]?.trim() === 'TRUE',
                                blog: cols[4]?.trim() === 'TRUE'
                            };
                        }
                    }
                });
                
                setState({ habitData: data, isConnected: true, isLoading: false });
            } catch (err) {
                setState({ 
                    error: `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 
                    isConnected: false, 
                    isLoading: false 
                });
            }
        }

        // ë Œë”ë§ í•¨ìˆ˜
        function render() {
            const app = document.getElementById('app');
            
            if (state.showSetup) {
                app.innerHTML = renderSetupPage();
                return;
            }
            
            app.innerHTML = renderMainPage();
            
            // ì•„ì´ì½˜ ì´ˆê¸°í™”
            lucide.createIcons();
        }

        // ì„¤ì • í˜ì´ì§€ ë Œë”ë§
        function renderSetupPage() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-lg shadow-md p-8">
                            <div class="text-center mb-6">
                                <i data-lucide="cloud" class="w-16 h-16 mx-auto text-blue-500 mb-4"></i>
                                <h1 class="text-2xl font-bold text-gray-800">êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°</h1>
                                <p class="text-gray-600 mt-2">ëª¨ë“  ê¸°ê¸°ì—ì„œ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”</p>
                            </div>

                            <div class="space-y-6">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <h3 class="font-semibold text-blue-800 mb-2">ğŸ“‹ ì„¤ì • ë°©ë²•</h3>
                                    <ol class="text-sm text-blue-700 space-y-1">
                                        <li>1. <a href="https://sheets.google.com" target="_blank" class="underline">êµ¬ê¸€ ì‹œíŠ¸</a>ì—ì„œ ìƒˆ ì‹œíŠ¸ ìƒì„±</li>
                                        <li>2. A1: Date, B1: Novel, C1: Exercise, D1: Japanese, E1: Blog ì…ë ¥</li>
                                        <li>3. íŒŒì¼ â†’ ê³µìœ  â†’ "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì" ì„¤ì •</li>
                                        <li>4. ê³µìœ  URL ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</li>
                                        <li>5. URL ëì˜ '/edit#gid=0'ì„ '/export?format=csv'ë¡œ ë³€ê²½</li>
                                    </ol>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        êµ¬ê¸€ ì‹œíŠ¸ CSV URL
                                    </label>
                                    <input
                                        type="url"
                                        id="sheetUrl"
                                        value="${state.sheetUrl}"
                                        placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        oninput="state.sheetUrl = this.value"
                                    />
                                </div>

                                <div class="bg-yellow-50 rounded-lg p-4">
                                    <h4 class="font-medium text-yellow-800 mb-1">âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
                                    <p class="text-sm text-yellow-700">
                                        ì´ ë°©ë²•ì€ ë°ì´í„°ë¥¼ ì½ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì²´í¬í•œ ë‚´ìš©ì€ ë¡œì»¬ì—ë§Œ ì €ì¥ë˜ë©°, 
                                        ë‹¤ë¥¸ ê¸°ê¸°ì™€ ì‹¤ì‹œê°„ ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                    </p>
                                </div>

                                <button
                                    onclick="connectToSheet()"
                                    class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2"
                                >
                                    <i data-lucide="cloud" class="w-5 h-5"></i>
                                    <span>ì—°ê²°í•˜ê¸°</span>
                                </button>

                                <button
                                    onclick="setState({ showSetup: false })"
                                    class="w-full text-gray-500 hover:text-gray-700 py-2"
                                >
                                    ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ë©”ì¸ í˜ì´ì§€ ë Œë”ë§
        function renderMainPage() {
            const todayStats = getWeekStats();
            const completedToday = habits.filter(h => isHabitDone(h.id)).length;
            const totalHabits = habits.length;

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- í—¤ë” -->
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“ ì¼ìƒ ìŠµê´€ ì¶”ì ê¸°</h1>
                            <p class="text-gray-600">í”„ë¡œì‘ê°€ë¥¼ í–¥í•œ ì—¬ì • ğŸ¯</p>
                            
                            <!-- ì—°ê²° ìƒíƒœ ë° ì„¤ì¹˜ ë²„íŠ¼ -->
                            <div class="flex items-center justify-center space-x-4 mt-2">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 rounded-full ${state.isConnected ? 'bg-green-500' : 'bg-gray-400'}"></div>
                                    <span class="text-sm text-gray-600">
                                        ${state.isConnected ? 'êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°ë¨' : 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ'}
                                    </span>
                                    <button
                                        onclick="setState({ showSetup: true })"
                                        class="text-xs text-blue-500 hover:text-blue-700 underline"
                                    >
                                        ì„¤ì •
                                    </button>
                                </div>
                                
                                <!-- PWA ì„¤ì¹˜ ë²„íŠ¼ -->
                                <button
                                    onclick="handleInstallClick()"
                                    class="flex items-center space-x-1 text-xs bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition-colors"
                                >
                                    <i data-lucide="download" class="w-3 h-3"></i>
                                    <span>ì•± ì„¤ì¹˜</span>
                                </button>
                            </div>
                        </div>

                        ${state.error ? `
                        <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-center space-x-2">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                            <span class="text-red-700">${state.error}</span>
                            <button
                                onclick="setState({ error: null })"
                                class="ml-auto text-red-500 hover:text-red-700"
                            >
                                âœ•
                            </button>
                        </div>
                        ` : ''}

                        <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <button 
                                    onclick="changeDate(-1)"
                                    class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    â† ì´ì „
                                </button>
                                <div class="text-center">
                                    <h2 class="text-xl font-semibold text-gray-800">${formatDate(state.currentDate)}</h2>
                                    <p class="text-sm text-gray-500">9ì›” 1ì¼ë¶€í„° ì‹œì‘!</p>
                                </div>
                                <button 
                                    onclick="changeDate(1)"
                                    class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors ${state.currentDate >= new Date() ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${state.currentDate >= new Date() ? 'disabled' : ''}
                                >
                                    ë‹¤ìŒ â†’
                                </button>
                            </div>

                            <!-- ì˜¤ëŠ˜ì˜ ì§„í–‰ìƒí™© -->
                            <div class="flex items-center justify-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="target" class="w-5 h-5 text-blue-500"></i>
                                    <span class="text-sm font-medium">ì˜¤ëŠ˜ ì™„ë£Œ: ${completedToday}/${totalHabits}</span>
                                </div>
                                <div class="px-3 py-1 rounded-full text-sm font-medium ${
                                    completedToday === totalHabits ? 'bg-green-100 text-green-800' :
                                    completedToday >= 2 ? 'bg-yellow-100 text-yellow-800' :
                                    completedToday >= 1 ? 'bg-blue-100 text-blue-800' :
                                    'bg-gray-100 text-gray-800'
                                }">
                                    ${completedToday === totalHabits ? 'ì™„ë²½!' :
                                      completedToday >= 2 ? 'í›Œë¥­!' :
                                      completedToday >= 1 ? 'ì¢‹ì•„ìš”!' : 'ì‹œì‘í•´ë³´ì„¸ìš”!'}
                                </div>
                                ${state.isLoading ? '<i data-lucide="loader" class="w-4 h-4 animate-spin text-blue-500"></i>' : ''}
                            </div>
                        </div>

                        <!-- ìŠµê´€ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                        <div class="grid gap-4 mb-6">
                            ${habits.map((habit) => `
                                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-3 h-3 rounded-full ${habit.color}"></div>
                                            <div>
                                                <div class="flex items-center space-x-2">
                                                    <h3 class="text-lg font-semibold text-gray-800">${habit.name}</h3>
                                                    <span class="px-2 py-1 text-xs rounded-full ${
                                                        habit.priority === 1 ? 'bg-red-100 text-red-800' :
                                                        habit.priority === 2 ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-green-100 text-green-800'
                                                    }">
                                                        ${habit.priority === 1 ? 'í•„ìˆ˜' : habit.priority === 2 ? 'ê¶Œì¥' : 'ì„ íƒ'}
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-600">${habit.description}</p>
                                                <p class="text-xs text-gray-500">${habit.target}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-4">
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-gray-700">ì´ë²ˆ ì£¼: ${todayStats[habit.id] || 0}/7</p>
                                                <p class="text-xs text-gray-500">ì—°ì†: ${getStreak(habit.id)}ì¼</p>
                                            </div>
                                            <button
                                                onclick="toggleHabit('${habit.id}')"
                                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 ${
                                                    isHabitDone(habit.id)
                                                        ? `${habit.color} text-white shadow-lg scale-105`
                                                        : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                                                }"
                                            >
                                                <i data-lucide="${isHabitDone(habit.id) ? 'check' : 'x'}" class="w-6 h-6"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- í†µê³„ ë° ê²©ë ¤ ë©”ì‹œì§€ -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                                ì´ë²ˆ ì£¼ í†µê³„
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                ${habits.map((habit) => `
                                    <div class="text-center">
                                        <div class="w-16 h-16 rounded-full ${habit.color} text-white flex items-center justify-center mx-auto mb-2">
                                            <span class="text-xl font-bold">${todayStats[habit.id] || 0}</span>
                                        </div>
                                        <p class="text-sm font-medium text-gray-700">${habit.name}</p>
                                        <p class="text-xs text-gray-500">${Math.round(((todayStats[habit.id] || 0) / 7) * 100)}%</p>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- ê²©ë ¤ ë©”ì‹œì§€ -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2">ğŸ’ª ê²©ë ¤ì˜ í•œë§ˆë””</h4>
                                <p class="text-sm text-gray-600">
                                    ${completedToday === totalHabits ? 
                                        "ì˜¤ëŠ˜ ëª¨ë“  ìŠµê´€ì„ ì™„ë£Œí–ˆë„¤ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”. ì´ í˜ì´ìŠ¤ë¥¼ ìœ ì§€í•˜ë©´ í•œ ë‹¬ì˜ ë²½ì„ ë„˜ì„ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”!" :
                                    completedToday >= 2 ?
                                        "ì¢‹ì€ ì§„ì „ì´ì—ìš”! ì†Œì„¤ ì“°ê¸°ë§Œí¼ì€ ê¼­ ìœ ì§€í•˜ë©´ì„œ ë‚˜ë¨¸ì§€ë„ ì°¨ê·¼ì°¨ê·¼ í•´ë‚˜ê°€ì„¸ìš”." :
                                    completedToday >= 1 ?
                                        "ì‹œì‘ì´ ë°˜ì´ì—ìš”! íŠ¹íˆ ì†Œì„¤ ì“°ê¸°ë¥¼ í–ˆë‹¤ë©´ ì˜¤ëŠ˜ì€ ì„±ê³µí•œ í•˜ë£¨ì…ë‹ˆë‹¤." :
                                        "ê´œì°®ì•„ìš”. '5ë¶„ë§Œ ì¨ë³´ì'ë¡œ ì†Œì„¤ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”. ì‘ì€ ì‹œì‘ì´ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤."}
                                </p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ğŸ’¡ ê¸°ì–µí•˜ì„¸ìš”: ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ì§€ì†í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤!
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    ${state.showInstallGuide ? renderInstallGuideModal() : ''}
                </div>
            `;
        }

        // ì„¤ì¹˜ ê°€ì´ë“œ ëª¨ë‹¬ ë Œë”ë§
        function renderInstallGuideModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <div class="text-center mb-6">
                            <i data-lucide="smartphone" class="w-16 h-16 mx-auto text-blue-500 mb-4"></i>
                            <h2 class="text-xl font-bold text-gray-800">ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</h2>
                            <p class="text-gray-600 mt-2">í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì ‘ê·¼í•˜ì„¸ìš”!</p>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h3 class="font-semibold text-blue-800 mb-2">ğŸ“± ëª¨ë°”ì¼ (Chrome/Safari)</h3>
                                <ol class="text-sm text-blue-700 space-y-1">
                                    <li>1. ë¸Œë¼ìš°ì € ë©”ë‰´(â‹®) í´ë¦­</li>
                                    <li>2. "í™ˆ í™”ë©´ì— ì¶”ê°€" ì„ íƒ</li>
                                    <li>3. "ì„¤ì¹˜" ë˜ëŠ” "ì¶”ê°€" ë²„íŠ¼ í´ë¦­</li>
                                </ol>
                            </div>

                            <div class="bg-green-50 rounded-lg p-4">
                                <h3 class="font-semibold text-green-800 mb-2">ğŸ’» PC (Chrome/Edge)</h3>
                                <ol class="text-sm text-green-700 space-y-1">
                                    <li>1. ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ ì„¤ì¹˜ ì•„ì´ì½˜ í´ë¦­</li>
                                    <li>2. ë˜ëŠ” ë©”ë‰´ â†’ "ì•± ì„¤ì¹˜"</li>
                                    <li>3. "ì„¤ì¹˜" ë²„íŠ¼ í´ë¦­</li>
                                </ol>
                            </div>

                            <div class="bg-yellow-50 rounded-lg p-4">
                                <h4 class="font-medium text-yellow-800 mb-1">âœ¨ ì„¤ì¹˜ í›„ ì¥ì </h4>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>â€¢ í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì‹¤í–‰</li>
                                    <li>â€¢ ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥</li>
                                    <li>â€¢ ì•±ì²˜ëŸ¼ ì „ì²´í™”ë©´ìœ¼ë¡œ ì‹¤í–‰</li>
                                    <li>â€¢ í‘¸ì‹œ ì•Œë¦¼ ì§€ì› (í–¥í›„ ì¶”ê°€)</li>
                                </ul>
                            </div>
                        </div>

                        <button
                            onclick="setState({ showInstallGuide: false })"
                            class="w-full mt-6 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300"
                        >
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
        }

        // PWA ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±
        function createManifest() {
            const manifest = {
                name: "ì¼ìƒ ìŠµê´€ ì¶”ì ê¸°",
                short_name: "ìŠµê´€ì¶”ì ê¸°",
                description: "í”„ë¡œì‘ê°€ë¥¼ í–¥í•œ ì—¬ì • - ë§¤ì¼ ìŠµê´€ì„ ì²´í¬í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”",
                start_url: "./",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#3b82f6",
                orientation: "portrait",
                icons: [
                    {
                        src: "data:image/svg+xml;base64," + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" fill="#3b82f6">
                                <rect width="192" height="192" rx="20" fill="#f0f7ff"/>
                                <path d="M48 64h96v8H48zm0 24h96v8H48zm0 24h72v8H48z" fill="#3b82f6"/>
                                <circle cx="32" cy="68" r="4" fill="#10b981"/>
                                <circle cx="32" cy="92" r="4" fill="#f59e0b"/>
                                <circle cx="32" cy="116" r="4" fill="#8b5cf6"/>
                            </svg>
                        `),
                        sizes: "192x192",
                        type: "image/svg+xml"
                    }
                ]
            };

            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            
            const manifestLink = document.getElementById('manifest-link');
            manifestLink.href = manifestUrl;
        }

        // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'habit-tracker-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/lucide@latest/dist/umd/lucide.js'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;
                
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', registration);
                    })
                    .catch(error => {
                        console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', error);
                    });
            }
        }

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                state.isInstallable = true;
            });

            window.addEventListener('appinstalled', () => {
                state.deferredPrompt = null;
                state.isInstallable = false;
                setState({ showInstallGuide: false });
            });
        }

        // ì´ˆê¸°í™”
        function init() {
            createManifest();
            registerServiceWorker();
            setupPWA();
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            if (state.sheetUrl && !state.showSetup) {
                loadDataFromSheet(state.sheetUrl);
            }
            
            render();
        }

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>