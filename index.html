<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ ê·¼ìœ¡ ìŠµê´€ ì¶”ì ê¸°</title>
    <meta name="description" content="í”„ë¡œì‘ê°€ë¥¼ í–¥í•œ ì—¬ì • - ê¸€ ê·¼ìœ¡ì„ í‚¤ìš°ëŠ” ì ì§„ì  í›ˆë ¨">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'korean': ['Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        * {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }
        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            line-height: 1.6;
        }
        .animate-pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        @keyframes pulse-gentle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .session-item {
            transition: all 0.3s ease;
        }
        .session-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .streak-flame {
            animation: flame 1.5s ease-in-out infinite alternate;
        }
        @keyframes flame {
            0% { transform: rotate(-2deg) scale(1); }
            100% { transform: rotate(2deg) scale(1.05); }
        }
        .streak-number {
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
        }
        .freeze-icon {
            animation: freeze-glow 2s ease-in-out infinite;
        }
        @keyframes freeze-glow {
            0%, 100% { filter: drop-shadow(0 0 5px #3b82f6); }
            50% { filter: drop-shadow(0 0 15px #1d4ed8); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“ ê¸€ ê·¼ìœ¡ í›ˆë ¨ì†Œ</h1>
                    <p class="text-gray-600">ì‘ê°€ì˜ ì²´ë ¥ì„ ë‹¨ê³„ë³„ë¡œ í‚¤ìš°ëŠ” ì—¬ì • ğŸ’ª</p>
                    
                    <div class="flex items-center justify-center space-x-4 mt-4">
                        <button onclick="exportData()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                            ğŸ“¥ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
                        </button>
                        <label class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm cursor-pointer">
                            ğŸ“¤ ë°ì´í„° ì—…ë¡œë“œ
                            <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-orange-500">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”¥ ì—°ì† ê¸°ë¡</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg p-4 border border-orange-200">
                                <div class="flex items-center justify-center mb-2">
                                    <span class="text-2xl streak-flame">ğŸ”¥</span>
                                </div>
                                <div class="text-3xl font-bold text-orange-600 streak-number mb-1" id="writingStreakDisplay">0</div>
                                <div class="text-sm text-gray-600">ê¸€ì“°ê¸° ì—°ì†ì¼</div>
                                <div class="text-xs text-gray-500 mt-1" id="writingStreakStatus">ì˜¤ëŠ˜ ì™„ë£Œí•˜ë©´ 1ì¼!</div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
                                <div class="flex items-center justify-center mb-2">
                                    <span class="text-2xl">ğŸ’ª</span>
                                </div>
                                <div class="text-3xl font-bold text-green-600 mb-1" id="exerciseStreakDisplay">0</div>
                                <div class="text-sm text-gray-600">ìš´ë™ ì—°ì†ì¼</div>
                                <div class="text-xs text-gray-500 mt-1" id="exerciseStreakStatus">ìš´ë™í•˜ê³  ê¸°ë¡ ì‹œì‘!</div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-200">
                                <div class="flex items-center justify-center mb-2">
                                    <span class="text-2xl">ğŸ¯</span>
                                </div>
                                <div class="text-3xl font-bold text-purple-600 mb-1" id="totalStreakDisplay">0</div>
                                <div class="text-sm text-gray-600">ì „ì²´ í™œë™ ì—°ì†ì¼</div>
                                <div class="text-xs text-gray-500 mt-1" id="totalStreakStatus">ë§¤ì¼ ë¬´ì–¸ê°€ëŠ” í•˜ì!</div>
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="freeze-icon">â„ï¸</span>
                                    <span class="text-sm font-medium text-blue-800">ì—°ì†ì¼ ë³´í˜¸ë§‰</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-blue-600" id="freezeCount">3ê°œ ë³´ìœ </div>
                                    <button onclick="useStreakFreeze()" id="freezeBtn" class="text-xs text-blue-500 hover:text-blue-700 mt-1">
                                        ë³´í˜¸ë§‰ ì‚¬ìš©í•˜ê¸°
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600 mt-2">
                                í•˜ë£¨ ë†“ì³ë„ ì—°ì† ê¸°ë¡ì„ ë³´í˜¸í•´ì£¼ëŠ” íŠ¹ë³„í•œ ë³´í˜¸ë§‰ì…ë‹ˆë‹¤. ì£¼ê°„ ëª©í‘œ ë‹¬ì„±ì‹œ ìë™ ì¶©ì „!
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">í˜„ì¬ ê¸€ ê·¼ìœ¡ ë ˆë²¨</h2>
                        <div class="flex items-center justify-center space-x-4">
                            <div class="text-4xl font-bold text-blue-600" id="currentLevel">1</div>
                            <div class="text-gray-600">
                                <div class="text-lg font-semibold" id="levelDescription">ì´ˆë³´ ì‘ê°€ (5ë¶„)</div>
                                <div class="text-sm" id="levelProgress">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: 0/7ì¼</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mt-4">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="text-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">í˜„ì¬ ìš´ë™ ë ˆë²¨</h2>
                            <div class="flex items-center justify-center space-x-4">
                                <div class="text-4xl font-bold text-green-600" id="currentExerciseLevel">1</div>
                                <div class="text-gray-600">
                                    <div class="text-lg font-semibold" id="exerciseLevelDescription">ì‹œì‘í•˜ëŠ” ë¼ì´ë”</div>
                                    <div class="text-sm" id="exerciseLevelProgress">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: 0/5íšŒ</div>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mt-4">
                                <div id="exerciseProgressBar" class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <div id="writing-level-1" class="p-2 bg-blue-100 rounded text-center">
                            <div class="font-semibold">Lv.1</div>
                            <div>5ë¶„</div>
                        </div>
                        <div id="writing-level-2" class="p-2 bg-gray-100 rounded text-center">
                            <div class="font-semibold">Lv.2</div>
                            <div>10ë¶„</div>
                        </div>
                        <div id="writing-level-3" class="p-2 bg-gray-100 rounded text-center">
                            <div class="font-semibold">Lv.3</div>
                            <div>15ë¶„</div>
                        </div>
                        <div id="writing-level-11" class="p-2 bg-gray-100 rounded text-center">
                            <div class="font-semibold">Lv.âˆ</div>
                            <div>4ì‹œê°„</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mt-2">
                        <div id="exercise-level-1" class="p-2 bg-green-100 rounded text-center">
                            <div class="font-semibold">Lv.1</div>
                            <div>5íšŒ</div>
                        </div>
                        <div id="exercise-level-2" class="p-2 bg-gray-100 rounded text-center">
                            <div class="font-semibold">Lv.2</div>
                            <div>10íšŒ</div>
                        </div>
                        <div id="exercise-level-3" class="p-2 bg-gray-100 rounded text-center">
                            <div class="font-semibold">Lv.3</div>
                            <div>20íšŒ</div>
                        </div>
                        <div id="exercise-level-6" class="p-2 bg-gray-100 rounded text-center">
                            <div class="font-semibold">Lv.âˆ</div>
                            <div>100íšŒ</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="changeDate(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                            â† ì´ì „
                        </button>
                        <div class="text-center">
                            <h2 id="currentDateText" class="text-xl font-semibold text-gray-800"></h2>
                            <button onclick="goToToday()" class="text-sm text-blue-500 hover:text-blue-700 mt-1">ì˜¤ëŠ˜ë¡œ ì´ë™</button>
                        </div>
                        <button onclick="changeDate(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                            ë‹¤ìŒ â†’
                        </button>
                    </div>

                    <div class="flex items-center justify-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-500">ğŸ¯</span>
                            <span id="progressText" class="text-sm font-medium">ì˜¤ëŠ˜ ì™„ë£Œ: 0/4</span>
                        </div>
                        <div id="progressBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            ì‹œì‘í•´ë³´ì„¸ìš”!
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">ğŸ“– ì˜¤ëŠ˜ì˜ ê¸€ì“°ê¸°</h3>
                                <p class="text-sm text-gray-600">í˜„ì¬ ëª©í‘œ: <span id="currentTarget" class="font-semibold text-blue-600">5ë¶„</span> ì´ìƒ</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-700">ì—°ì†: <span id="novel-streak">0</span>ì¼</p>
                            <p class="text-xs text-gray-500">ì´ë²ˆ ì£¼: <span id="novel-week">0</span>/7</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">ì˜¤ëŠ˜ì˜ ì‘ì—… ê¸°ë¡</h4>
                        <div id="sessionsContainer" class="space-y-2 mb-3">
                        </div>
                        
                        <div id="totalSummary" class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">ì˜¤ëŠ˜ ì´ ê¸€ì“°ê¸°</span>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-blue-600" id="dailyTotal">0ë¶„ Â· 0ì</div>
                                    <div class="text-xs" id="goalStatus">ëª©í‘œê¹Œì§€ 5ë¶„ í•„ìš”</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ì‹œê°„ (ë¶„)</label>
                                <input 
                                    type="number" 
                                    id="sessionMinutes" 
                                    min="1" 
                                    max="480" 
                                    placeholder="15"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ê¸€ì ìˆ˜</label>
                                <input 
                                    type="number" 
                                    id="sessionCharacters" 
                                    min="0" 
                                    max="50000"
                                    placeholder="300"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                            </div>
                        </div>
                        
                        <button onclick="addSession()" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium mb-3">
                            + ì„¸ì…˜ ì¶”ê°€
                        </button>

                        <button 
                            onclick="toggleDayComplete()" 
                            id="dayCompleteBtn" 
                            class="w-full px-6 py-3 rounded-lg font-medium transition-all duration-200 bg-gray-200 text-gray-600"
                        >
                            ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„± ì™„ë£Œ
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-4 h-4 rounded-full bg-green-500"></div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">ğŸƒ ì˜¤ëŠ˜ì˜ ìš´ë™</h3>
                                <p class="text-sm text-gray-600">ëª¸ì˜ ì²´ë ¥ = ê¸€ì˜ ì²´ë ¥</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-700">ì—°ì†: <span id="exercise-streak">0</span>ì¼</p>
                            <p class="text-xs text-gray-500">ì´ë²ˆ ì£¼: <span id="exercise-week">0</span>/7</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡</h4>
                        <div id="exerciseSessionsContainer" class="space-y-2 mb-3">
                        </div>
                        
                        <div id="exerciseTotalSummary" class="p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">ì˜¤ëŠ˜ ì´ ìš´ë™</span>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-green-600" id="exerciseDailyTotal">0ë¶„ Â· 0kcal</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ì‹œê°„ (ë¶„)</label>
                                <input type="number" id="exerciseMinutes" min="1" placeholder="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ì†Œëª¨ ì¹¼ë¡œë¦¬ (kcal)</label>
                                <input type="number" id="exerciseCalories" min="0" placeholder="250" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <button onclick="addExerciseSession()" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium mb-3">
                            + ìš´ë™ ê¸°ë¡ ì¶”ê°€
                        </button>
                    </div>
                </div>
                
                <div id="customHabitsContainer" class="grid gap-4 mb-6">
                    </div>


                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“Š ê¸€ ê·¼ìœ¡ ë¶„ì„</h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="weeklyMinutes">0</div>
                            <div class="text-sm text-gray-600">ì´ë²ˆ ì£¼ ì´ ê¸€ì“°ê¸°</div>
                            <div class="text-xs text-gray-500">ë¶„</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="averageMinutes">0</div>
                            <div class="text-sm text-gray-600">ì¼í‰ê·  ê¸€ì“°ê¸°</div>
                            <div class="text-xs text-gray-500">ë¶„</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="weeklyCharacters">0</div>
                            <div class="text-sm text-gray-600">ì´ë²ˆ ì£¼ ì´ ê¸€ì</div>
                            <div class="text-xs text-gray-500">ì</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="averageCharacters">0</div>
                            <div class="text-sm text-gray-600">ì¼í‰ê·  ê¸€ì</div>
                            <div class="text-xs text-gray-500">ì</div>
                        </div>
                    </div>

                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-3">ğŸ“ˆ ì„±ì¥ ì§€í‘œ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ë¶„ë‹¹ í‰ê·  ê¸€ì ìˆ˜:</span>
                                <span id="charactersPerMinute" class="font-medium text-gray-800">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ìµœê³  ê¸°ë¡ (ì¼ì¼):</span>
                                <span id="dailyBest" class="font-medium text-gray-800">0ì</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ìµœì¥ ì—°ì†:</span>
                                <span id="longestStreak" class="font-medium text-gray-800">0ì¼</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ì´ ëˆ„ì :</span>
                                <span id="totalCharacters" class="font-medium text-gray-800">0ì</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-800 mb-2">ğŸ‹ï¸ ì½”ì¹˜ì˜ ì¡°ì–¸</h4>
                        <p id="coachAdvice" class="text-sm text-gray-700 mb-2">
                            ê¸€ ê·¼ìœ¡ì€ í•˜ë£¨ì•„ì¹¨ì— ìƒê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¾¸ì¤€í•¨ì´ í•µì‹¬ì´ì—ìš”.
                        </p>
                        <p class="text-xs text-gray-600" id="nextLevelHint">
                            ğŸ’¡ 7ì¼ ë” ì—°ì†ìœ¼ë¡œ ë‹¬ì„±í•˜ë©´ ë‹¤ìŒ ë ˆë²¨ë¡œ ìŠ¹ê¸‰!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ê¸€ ê·¼ìœ¡ ë ˆë²¨ ì‹œìŠ¤í…œ
        const WRITING_LEVELS = [
            { level: 1, minutes: 5, title: "ì´ˆë³´ ì‘ê°€", description: "ì²« ê±¸ìŒì„ ë–¼ëŠ” ë‹¨ê³„", daysRequired: 7 },
            { level: 2, minutes: 10, title: "ìŠµê´€ ì‘ê°€", description: "ë£¨í‹´ì´ ì¡íˆëŠ” ë‹¨ê³„", daysRequired: 7 },
            { level: 3, minutes: 15, title: "ê¾¸ì¤€í•œ ì‘ê°€", description: "ì•ˆì •ì ì¸ ê¸€ì“°ê¸°", daysRequired: 7 },
            { level: 4, minutes: 20, title: "ì§‘ì¤‘ ì‘ê°€", description: "ëª°ì…ì˜ ì‹œì‘", daysRequired: 10 },
            { level: 5, minutes: 30, title: "ì§€ì† ì‘ê°€", description: "ê¹Šì€ ì‚¬ê³ ì˜ ì‹œì‘", daysRequired: 10 },
            { level: 6, minutes: 45, title: "ìˆ™ë ¨ ì‘ê°€", description: "ê¸€ì˜ íë¦„ì„ íƒ€ëŠ” ë‹¨ê³„", daysRequired: 14 },
            { level: 7, minutes: 60, title: "ì „ë¬¸ ì‘ê°€", description: "1ì‹œê°„ ì§‘ì¤‘ë ¥ ì™„ì„±", daysRequired: 14 },
            { level: 8, minutes: 90, title: "ë§ˆìŠ¤í„° ì‘ê°€", description: "ê¹Šì€ ëª°ì… ìƒíƒœ", daysRequired: 21 },
            { level: 9, minutes: 120, title: "ë² í…Œë‘ ì‘ê°€", description: "2ì‹œê°„ ì—°ì† ê¸€ì“°ê¸°", daysRequired: 21 },
            { level: 10, minutes: 180, title: "í”„ë¡œ ì‘ê°€", description: "3ì‹œê°„ ì§€êµ¬ë ¥", daysRequired: 30 },
            { level: 11, minutes: 240, title: "ë§ˆë¼í†¤ ì‘ê°€", description: "4ì‹œê°„ ì™„ì£¼ ê°€ëŠ¥", daysRequired: 30 }
        ];

        // ìš´ë™ ë ˆë²¨ ì‹œìŠ¤í…œ
        const EXERCISE_LEVELS = [
            { level: 1, title: "ì‹œì‘í•˜ëŠ” ë¼ì´ë”", required: 5, description: "5íšŒ" },
            { level: 2, title: "ìŠµê´€ ë¼ì´ë”", required: 10, description: "10íšŒ" },
            { level: 3, title: "ì§€ì† ë¼ì´ë”", required: 20, description: "20íšŒ" },
            { level: 4, title: "ì§€êµ¬ë ¥ ë¼ì´ë”", required: 30, description: "30íšŒ" },
            { level: 5, title: "ì—´ì • ë¼ì´ë”", required: 50, description: "50íšŒ" },
            { level: 6, title: "ë§ˆìŠ¤í„° ë¼ì´ë”", required: 100, description: "100íšŒ" }
        ];

        // ì „ì—­ ìƒíƒœ
        let state = {
            currentDate: new Date(),
            habitData: JSON.parse(localStorage.getItem('habitData') || '{}'),
            currentLevel: parseInt(localStorage.getItem('currentLevel') || '1'),
            levelProgress: parseInt(localStorage.getItem('levelProgress') || '0'),
            currentExerciseLevel: parseInt(localStorage.getItem('currentExerciseLevel') || '1'),
            streakFreezes: parseInt(localStorage.getItem('streakFreezes') || '3'),
            lastFreezeUse: localStorage.getItem('lastFreezeUse') || null
        };

        // ìŠµê´€ ìƒˆë¡œ ì‘ì„± (ì¼ë³¸ì–´, ë¸”ë¡œê·¸ë¥¼ í¬í•¨í•˜ë„ë¡ ì´ˆê¸°í™” ë¡œì§ì´ ì¶”ê°€ë¨)
        let customHabits = JSON.parse(localStorage.getItem('customHabits') || '[]');

        // ê¸°ì¡´ ê³ ì • ìŠµê´€ ëª©ë¡ì€ ì‚­ì œë¨
        // const habits = ['japanese', 'blog']; 

        // v3.0: ê³ ì • ìŠµê´€ì„ customHabitsì— í†µí•©í•˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜
        function migrateFixedHabits() {
            const fixedHabits = [
                { id: 'japanese', name: 'ì¼ë³¸ì–´', type: 'simple', color: 'yellow', description: 'ì–¸ì–´ì˜ ë‹¤ì–‘ì„± í™•ì¥', createdAt: '2023-01-01T00:00:00.000Z' },
                { id: 'blog', name: 'ë¸”ë¡œê·¸', type: 'simple', color: 'purple', description: 'ê¸€ì“°ê¸° ì‹¤ì „ ì—°ìŠµ', createdAt: '2023-01-01T00:00:00.001Z' }
            ];

            let isModified = false;
            fixedHabits.forEach(fixedHabit => {
                // ì´ë¯¸ customHabitsì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const exists = customHabits.some(h => h.id === fixedHabit.id);

                // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ì„œ, ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— í•´ë‹¹ ìŠµê´€ì˜ ê¸°ë¡ì´ ë‚¨ì•„ìˆë‹¤ë©´ ë³µêµ¬
                if (!exists) {
                    let hasOldRecord = Object.values(state.habitData).some(dayData => 
                        dayData[fixedHabit.id] !== undefined
                    );
                    
                    if (!hasOldRecord) {
                         // ê¸°ë¡ì´ ì „í˜€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì´ˆê¸°í™” ë°©ì§€.
                        // í•˜ì§€ë§Œ ì‚­ì œ ê¸°ëŠ¥ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì¼ë‹¨ ê¸°ë³¸ì ìœ¼ë¡œ ì¶”ê°€
                    }
                    
                    customHabits.push(fixedHabit);
                    isModified = true;
                }
            });

            if (isModified) {
                localStorage.setItem('customHabits', JSON.stringify(customHabits));
            }
        }
        
        // ì—°ì†ì¼ ë³´í˜¸ë§‰ ì‹œìŠ¤í…œ (ìƒˆë¡œ ì¶”ê°€)
        function useStreakFreeze() {
            if (state.streakFreezes <= 0) {
                alert('ë³´í˜¸ë§‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì£¼ê°„ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì—¬ ë³´í˜¸ë§‰ì„ ì¶©ì „í•˜ì„¸ìš”!');
                return;
            }

            const today = getDateKey(state.currentDate);
            if (state.lastFreezeUse === today) {
                alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ ë³´í˜¸ë§‰ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (confirm('ì—°ì†ì¼ ë³´í˜¸ë§‰ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì˜¤ëŠ˜ì˜ ì—°ì† ê¸°ë¡ì´ ë³´í˜¸ë©ë‹ˆë‹¤.')) {
                state.streakFreezes--;
                state.lastFreezeUse = today;
                
                // ì˜¤ëŠ˜ ë‚ ì§œì— ë³´í˜¸ë§‰ ì‚¬ìš© ê¸°ë¡
                const dateKey = getDateKey(state.currentDate);
                if (!state.habitData[dateKey]) {
                    state.habitData[dateKey] = {};
                }
                state.habitData[dateKey].streakFreeze = true;
                
                localStorage.setItem('streakFreezes', state.streakFreezes.toString());
                localStorage.setItem('lastFreezeUse', state.lastFreezeUse);
                localStorage.setItem('habitData', JSON.stringify(state.habitData));
                
                updateUI();
                alert('âœ¨ ë³´í˜¸ë§‰ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! ì˜¤ëŠ˜ì˜ ì—°ì† ê¸°ë¡ì´ ë³´í˜¸ë©ë‹ˆë‹¤.');
            }
        }

        function checkWeeklyGoalAndRewardFreeze() {
            const weekStats = getWeeklyWritingStats();
            const weeklyExerciseStats = getWeeklyExerciseStats();
            
            // ì£¼ê°„ ëª©í‘œ: ê¸€ì“°ê¸° 5ì¼ + ìš´ë™ 3ì¼ ë˜ëŠ” ì´ 6ì¼ í™œë™
            const totalWeeklyActivity = weekStats.completedDays + weeklyExerciseStats.completedDays;
            
            if (weekStats.completedDays >= 5 || totalWeeklyActivity >= 6) {
                const currentWeek = getWeekNumber(state.currentDate);
                const lastRewardWeek = localStorage.getItem('lastFreezeRewardWeek');
                
                if (lastRewardWeek !== currentWeek.toString()) {
                    state.streakFreezes = Math.min(state.streakFreezes + 1, 5); // ìµœëŒ€ 5ê°œ
                    localStorage.setItem('streakFreezes', state.streakFreezes.toString());
                    localStorage.setItem('lastFreezeRewardWeek', currentWeek.toString());
                    
                    setTimeout(() => {
                        alert('ğŸ‰ ì£¼ê°„ ëª©í‘œ ë‹¬ì„±! ì—°ì†ì¼ ë³´í˜¸ë§‰ 1ê°œê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }, 500);
                }
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function addCustomHabit() {
            const habitName = prompt('ìƒˆë¡œìš´ ìŠµê´€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!habitName || habitName.trim() === '') return;
            
            const habitType = confirm('ë ˆë²¨ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì¸: ë ˆë²¨ ì‹œìŠ¤í…œ (íšŸìˆ˜ ê¸°ë°˜)\nì·¨ì†Œ: ë‹¨ìˆœ ì²´í¬ (ì™„ë£Œ/ë¯¸ì™„ë£Œ)');
            
            let habitConfig = {
                id: 'custom_' + Date.now(),
                name: habitName.trim(),
                type: habitType ? 'level' : 'simple',
                color: prompt('ìŠµê´€ ìƒ‰ìƒì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: blue, green, red, purple, yellow, pink, indigo):', 'blue') || 'blue',
                description: prompt('ìŠµê´€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë§¤ì¼ 10ë¶„):', 'ìƒˆë¡œìš´ ìŠµê´€'),
                createdAt: new Date().toISOString()
            };
            
            if (habitType) {
                // ë ˆë²¨ ì‹œìŠ¤í…œ ì„¤ì •
                const targetCount = parseInt(prompt('ëª©í‘œ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 10):', '10')) || 10;
                habitConfig.levels = [
                    { level: 1, required: Math.ceil(targetCount * 0.2), title: "ì‹œì‘" },
                    { level: 2, required: Math.ceil(targetCount * 0.4), title: "ë°œì „" },
                    { level: 3, required: Math.ceil(targetCount * 0.6), title: "ìˆ™ë ¨" },
                    { level: 4, required: Math.ceil(targetCount * 0.8), title: "ì „ë¬¸" },
                    { level: 5, required: targetCount, title: "ë§ˆìŠ¤í„°" }
                ];
                habitConfig.currentLevel = 1;
            }
            
            customHabits.push(habitConfig);
            localStorage.setItem('customHabits', JSON.stringify(customHabits));
            
            renderCustomHabits();
            updateUI();
            alert(`"${habitName}" ìŠµê´€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ ìˆ˜ì • (í˜„ì¬ëŠ” ì•Œë¦¼ë§Œ í‘œì‹œ)
        function editCustomHabit(habitId) {
            alert('âš™ï¸ ìŠµê´€ ìˆ˜ì • ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ID: ' + habitId + ')');
        }

        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ ì‚­ì œ
        function removeCustomHabit(habitId) {
            const habit = customHabits.find(h => h.id === habitId);
            if (!habit || !confirm(`ì •ë§ "${habit.name}" ìŠµê´€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìŠµê´€ê³¼ ê´€ë ¨ëœ ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
            
            // 1. customHabits ë°°ì—´ì—ì„œ ì‚­ì œ
            customHabits = customHabits.filter(h => h.id !== habitId);
            localStorage.setItem('customHabits', JSON.stringify(customHabits));
            
            // 2. habitDataì—ì„œ ê´€ë ¨ ê¸°ë¡ ì‚­ì œ
            Object.keys(state.habitData).forEach(dateKey => {
                delete state.habitData[dateKey][habitId];
                delete state.habitData[dateKey][habitId + '_count'];
            });
            localStorage.setItem('habitData', JSON.stringify(state.habitData));
            
            updateUI();
            alert(`"${habit.name}" ìŠµê´€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ ì™„ë£Œ ìƒíƒœ í™•ì¸
        function isCustomHabitDone(habitId) {
            const dateKey = getDateKey(state.currentDate);
            const habit = customHabits.find(h => h.id === habitId);
            if (!habit) return false;

            if (habit.type === 'simple') {
                 return state.habitData[dateKey]?.[habitId] || false;
            }
            if (habit.type === 'level') {
                return state.habitData[dateKey]?.[habitId + '_count'] > 0;
            }
            return false;
        }

        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ í†µê³„
        function getCustomHabitStats(habitId) {
            let totalCount = 0;
            Object.values(state.habitData).forEach(dayData => {
                if (dayData[habitId + '_count']) {
                    totalCount += dayData[habitId + '_count'];
                }
            });
            return { totalCount };
        }

        // ì—°ì†ì¼ ê³„ì‚° í•¨ìˆ˜ë“¤ (ê°œì„ ë¨)
        function getWritingStreakWithFreeze() {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            let usedFreeze = false;
            
            while (true) {
                const dateKey = getDateKey(checkDate);
                const writingData = getWritingData(checkDate);
                const hasFreeze = state.habitData[dateKey]?.streakFreeze;
                
                if (writingData.completed) {
                    streak++;
                } else if (hasFreeze && !usedFreeze) {
                    // ë³´í˜¸ë§‰ì´ ìˆìœ¼ë©´ ì—°ì† ê¸°ë¡ ìœ ì§€
                    streak++;
                    usedFreeze = true;
                } else {
                    break;
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            return streak;
        }

        function getExerciseStreakWithFreeze() {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            let usedFreeze = false;
            
            while (true) {
                const dateKey = getDateKey(checkDate);
                const exerciseData = state.habitData[dateKey]?.exercise;
                const hasExercise = exerciseData && exerciseData.sessions && exerciseData.sessions.length > 0;
                const hasFreeze = state.habitData[dateKey]?.streakFreeze;
                
                if (hasExercise) {
                    streak++;
                } else if (hasFreeze && !usedFreeze) {
                    streak++;
                    usedFreeze = true;
                } else {
                    break;
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            return streak;
        }

        function getTotalActivityStreakWithFreeze() {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            let usedFreeze = false;
            
            while (true) {
                const dateKey = getDateKey(checkDate);
                const dayData = state.habitData[dateKey];
                const hasFreeze = dayData?.streakFreeze;
                
                let hasAnyActivity = (dayData?.writing?.completed) || (dayData?.exercise?.sessions?.length > 0);
                
                // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ í¬í•¨
                customHabits.forEach(habit => {
                    if (isCustomHabitDone(habit.id)) {
                        hasAnyActivity = true;
                    }
                });

                if (hasAnyActivity) {
                    streak++;
                } else if (hasFreeze && !usedFreeze) {
                    streak++;
                    usedFreeze = true;
                } else {
                    break;
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            return streak;
        }

        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ í† ê¸€
        function toggleCustomHabit(habitId) {
            const dateKey = getDateKey(state.currentDate);
            const habit = customHabits.find(h => h.id === habitId);

            if (!habit || habit.type !== 'simple') return;

            if (!state.habitData[dateKey]) {
                state.habitData[dateKey] = {};
            }
            
            state.habitData[dateKey][habitId] = !state.habitData[dateKey][habitId];
            localStorage.setItem('habitData', JSON.stringify(state.habitData));
            
            checkWeeklyGoalAndRewardFreeze();
            updateUI();
        }

        // ë ˆë²¨ ì‹œìŠ¤í…œ ìŠµê´€ ì¹´ìš´íŠ¸ ì¶”ê°€
        function addCustomHabitCount(habitId) {
            const habit = customHabits.find(h => h.id === habitId);
            if (!habit || habit.type !== 'level') return;
            
            const dateKey = getDateKey(state.currentDate);
            if (!state.habitData[dateKey]) {
                state.habitData[dateKey] = {};
            }
            if (!state.habitData[dateKey][habitId + '_count']) {
                state.habitData[dateKey][habitId + '_count'] = 0;
            }
            
            state.habitData[dateKey][habitId + '_count']++;
            localStorage.setItem('habitData', JSON.stringify(state.habitData));
            
            // ë ˆë²¨ì—… ì²´í¬
            checkCustomHabitLevelUp(habitId);
            
            updateUI();
        }


        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ ë ˆë²¨ì—… ì²´í¬
        function checkCustomHabitLevelUp(habitId) {
            const habit = customHabits.find(h => h.id === habitId);
            if (!habit || habit.type !== 'level') return;
            
            const stats = getCustomHabitStats(habitId);
            const nextLevel = habit.levels.find(l => l.level === habit.currentLevel + 1);
            
            if (nextLevel && stats.totalCount >= nextLevel.required) {
                habit.currentLevel++;
                localStorage.setItem('customHabits', JSON.stringify(customHabits));
                
                setTimeout(() => {
                    alert(`ğŸ‰ "${habit.name}" ë ˆë²¨ì—…! Lv.${habit.currentLevel} ${nextLevel.title} ë‹¬ì„±!`);
                }, 500);
            }
        }
        
        // ì—°ì†ì¼ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        function updateStreakUI() {
            const writingStreak = getWritingStreakWithFreeze();
            const exerciseStreak = getExerciseStreakWithFreeze();
            const totalStreak = getTotalActivityStreakWithFreeze();
            
            document.getElementById('writingStreakDisplay').textContent = writingStreak;
            document.getElementById('exerciseStreakDisplay').textContent = exerciseStreak;
            document.getElementById('totalStreakDisplay').textContent = totalStreak;
            
            // ì—°ì†ì¼ ìƒíƒœ ë©”ì‹œì§€
            const todayWriting = getWritingData(state.currentDate);
            if (todayWriting.completed) {
                document.getElementById('writingStreakStatus').textContent = 'ì˜¤ëŠ˜ ì™„ë£Œ! ğŸ”¥';
            } else if (writingStreak > 0) {
                document.getElementById('writingStreakStatus').textContent = 'ì˜¤ëŠ˜ ì™„ë£Œí•˜ë©´ ' + (writingStreak + 1) + 'ì¼!';
            } else {
                document.getElementById('writingStreakStatus').textContent = 'ì˜¤ëŠ˜ ì™„ë£Œí•˜ë©´ 1ì¼!';
            }
            
            const todayExercise = isExerciseDone();
            if (todayExercise) {
                document.getElementById('exerciseStreakStatus').textContent = 'ì˜¤ëŠ˜ ì™„ë£Œ! ğŸ’ª';
            } else if (exerciseStreak > 0) {
                document.getElementById('exerciseStreakStatus').textContent = 'ìš´ë™í•˜ë©´ ' + (exerciseStreak + 1) + 'ì¼!';
            } else {
                document.getElementById('exerciseStreakStatus').textContent = 'ìš´ë™í•˜ê³  ê¸°ë¡ ì‹œì‘!';
            }
            
            // ì „ì²´ í™œë™ í™•ì¸ ë¡œì§ (ì‚¬ìš©ì ì •ì˜ ìŠµê´€ í¬í•¨)
            let hasAnyActivity = isHabitDone('writing') || isExerciseDone();
            customHabits.forEach(habit => {
                if (isCustomHabitDone(habit.id)) {
                    hasAnyActivity = true;
                }
            });

            if (hasAnyActivity) {
                document.getElementById('totalStreakStatus').textContent = 'ì˜¤ëŠ˜ë„ í™œë™! ğŸ¯';
            } else if (totalStreak > 0) {
                document.getElementById('totalStreakStatus').textContent = 'í™œë™í•˜ë©´ ' + (totalStreak + 1) + 'ì¼!';
            } else {
                document.getElementById('totalStreakStatus').textContent = 'ë§¤ì¼ ë¬´ì–¸ê°€ëŠ” í•˜ì!';
            }
            
            // ë³´í˜¸ë§‰ UI ì—…ë°ì´íŠ¸
            document.getElementById('freezeCount').textContent = state.streakFreezes + 'ê°œ ë³´ìœ ';
            const freezeBtn = document.getElementById('freezeBtn');
            if (state.streakFreezes <= 0) {
                freezeBtn.textContent = 'ë³´í˜¸ë§‰ ì—†ìŒ';
                freezeBtn.className = 'text-xs text-gray-400 mt-1';
            } else if (state.lastFreezeUse === getDateKey(state.currentDate)) {
                freezeBtn.textContent = 'ì˜¤ëŠ˜ ì‚¬ìš©í•¨';
                freezeBtn.className = 'text-xs text-blue-400 mt-1';
            } else {
                freezeBtn.textContent = 'ë³´í˜¸ë§‰ ì‚¬ìš©í•˜ê¸°';
                freezeBtn.className = 'text-xs text-blue-500 hover:text-blue-700 mt-1 cursor-pointer';
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ìŠµê´€ ë Œë”ë§
        function renderCustomHabits() {
            const container = document.getElementById('customHabitsContainer');
            if (!container) return; 
            
            const totalHabits = customHabits.length;

            if (totalHabits === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-4 border-2 border-dashed border-gray-300">
                        <div class="text-center">
                            <p class="text-gray-600 mb-3">ë‚˜ë§Œì˜ ìŠµê´€ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                            <button onclick="addCustomHabit()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                                + ìƒˆ ìŠµê´€ ì¶”ê°€
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let habitHTML = customHabits.map(habit => {
                const colorClasses = {
                    blue: 'bg-blue-500 border-blue-200',
                    green: 'bg-green-500 border-green-200',
                    red: 'bg-red-500 border-red-200',
                    purple: 'bg-purple-500 border-purple-200',
                    yellow: 'bg-yellow-500 border-yellow-200',
                    pink: 'bg-pink-500 border-pink-200',
                    indigo: 'bg-indigo-500 border-indigo-200'
                };
                
                const isDone = isCustomHabitDone(habit.id);
                const btnClass = isDone ? colorClasses[habit.color] : 'bg-gray-200 border-gray-200';
                
                let statusText = habit.description || 'ë°˜ë³µì ì¸ í™œë™';
                let extraControls = '';
                
                if (habit.type === 'level') {
                    const stats = getCustomHabitStats(habit.id);
                    const currentLevelData = habit.levels.find(l => l.level === habit.currentLevel) || habit.levels[0];
                    const nextLevel = habit.levels.find(l => l.level === habit.currentLevel + 1);
                    const nextRequired = nextLevel ? nextLevel.required : currentLevelData.required;

                    statusText = `Lv.${habit.currentLevel} | ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${stats.totalCount} / ${nextRequired}íšŒ`;
                    extraControls = `
                        <button onclick="addCustomHabitCount('${habit.id}')" class="px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded hover:bg-blue-200 transition-colors" title="íšŸìˆ˜ ì¶”ê°€">+1</button>
                    `;
                }
                
                return `
                    <div class="bg-white rounded-lg shadow-md p-4 border-l-4 ${colorClasses[habit.color].split(' ')[1]}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full ${colorClasses[habit.color].split(' ')[0]}"></div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${habit.name}</h4>
                                    <p class="text-xs text-gray-600">${statusText}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${extraControls}
                                ${habit.type === 'simple' ? `
                                    <button onclick="toggleCustomHabit('${habit.id}')" class="w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 ${btnClass} ${isDone ? 'text-white shadow-lg' : 'text-gray-500 hover:bg-gray-300'}">
                                        <span class="text-xl">${isDone ? 'âœ“' : 'âœ—'}</span>
                                    </button>` : ''
                                }
                                <button onclick="removeCustomHabit('${habit.id}')" class="text-red-400 hover:text-red-600 text-xs" title="ìŠµê´€ ì‚­ì œ">âœ•</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            habitHTML += `
                <div class="bg-white rounded-lg shadow-md p-4 border-2 border-dashed border-gray-300">
                    <div class="text-center">
                        <button onclick="addCustomHabit()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                            + ìƒˆ ìŠµê´€ ì¶”ê°€
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = habitHTML;
        }
        
        // UIì—ì„œ ìŠµê´€ ê´€ë ¨ ë¶€ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateCustomHabitsInUI() {
            renderCustomHabits();
            
            // ì „ì²´ ì§„í–‰ë¥  ê³„ì‚°ì— ëª¨ë“  ìŠµê´€ í¬í•¨
            const totalHabits = 1 + 1 + customHabits.length; // ê¸€ì“°ê¸° + ìš´ë™ + ì‚¬ìš©ì ì •ì˜/ë³´ì¡° ìŠµê´€ ìˆ˜

            // ì™„ë£Œëœ í•­ëª© ìˆ˜ ê³„ì‚° (ê¸€ì“°ê¸°, ìš´ë™, ëª¨ë“  ì»¤ìŠ¤í…€ ìŠµê´€)
            const completedWriting = getWritingData(state.currentDate).completed ? 1 : 0;
            const completedExercise = isExerciseDone() ? 1 : 0;
            
            const completedCustom = customHabits.filter(habit => isCustomHabitDone(habit.id)).length;
            
            const totalCompleted = completedWriting + completedExercise + completedCustom;
            
            document.getElementById('progressText').textContent = `ì˜¤ëŠ˜ ì™„ë£Œ: ${totalCompleted}/${totalHabits}`;
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('ko-KR', options);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function getCurrentLevel() {
            return WRITING_LEVELS.find(level => level.level === state.currentLevel) || WRITING_LEVELS[0];
        }

        function goToToday() {
            state.currentDate = new Date();
            updateUI();
        }

        // ì…ë ¥ ê²€ì¦ í•¨ìˆ˜
        function validateSessionInput(minutes, characters) {
            const errors = [];
            
            if (!minutes || isNaN(minutes)) {
                errors.push('ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            } else if (minutes <= 0) {
                errors.push('ì‹œê°„ì€ 1ë¶„ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            } else if (minutes > 480) {
                errors.push('ì‹œê°„ì€ 8ì‹œê°„(480ë¶„) ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
            
            if (characters !== null && characters !== undefined && characters !== '') {
                if (isNaN(characters)) {
                    errors.push('ê¸€ì ìˆ˜ëŠ” ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                } else if (characters < 0) {
                    errors.push('ê¸€ì ìˆ˜ëŠ” ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else if (characters > 50000) {
                    errors.push('ê¸€ì ìˆ˜ëŠ” 50,000ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }
            
            return errors;
        }

        // ë°ì´í„° ê²€ì¦ ë° ìˆ˜ì • í•¨ìˆ˜
        function validateAndFixWritingData(data) {
            if (!data) return createEmptyWritingData();
            
            if (!data.sessions) data.sessions = [];
            if (typeof data.completed !== 'boolean') data.completed = false;
            
            data.sessions = data.sessions.filter(session => {
                return session && 
                       typeof session.timestamp === 'number' && 
                       typeof session.minutes === 'number' && 
                       session.minutes > 0 &&
                       typeof session.characters === 'number' && 
                       session.characters >= 0;
            });
            
            data.totalMinutes = data.sessions.reduce((sum, s) => sum + s.minutes, 0);
            data.totalCharacters = data.sessions.reduce((sum, s) => sum + s.characters, 0);
            
            return data;
        }

        function createEmptyWritingData() {
            return {
                completed: false,
                sessions: [],
                totalMinutes: 0,
                totalCharacters: 0
            };
        }

        function getWritingData(date) {
            const dateKey = getDateKey(date);
            const rawData = state.habitData[dateKey]?.writing;
            
            if (rawData && rawData.minutes !== undefined && !rawData.sessions) {
                const convertedData = {
                    completed: rawData.completed || false,
                    sessions: rawData.completed ? [{
                        timestamp: createTimestamp(date, 9, 0),
                        minutes: rawData.minutes || 0,
                        characters: rawData.characters || 0
                    }] : [],
                    totalMinutes: rawData.minutes || 0,
                    totalCharacters: rawData.characters || 0
                };
                
                saveWritingData(date, convertedData);
                return convertedData;
            }
            
            return validateAndFixWritingData(rawData);
        }

        function createTimestamp(date, hours = null, minutes = null) {
            const newDate = new Date(date);
            if (hours !== null) newDate.setHours(hours);
            if (minutes !== null) newDate.setMinutes(minutes);
            return newDate.getTime();
        }

        function saveWritingData(date, writingData) {
            try {
                const dateKey = getDateKey(date);
                if (!state.habitData[dateKey]) {
                    state.habitData[dateKey] = {};
                }
                
                state.habitData[dateKey].writing = validateAndFixWritingData(writingData);
                localStorage.setItem('habitData', JSON.stringify(state.habitData));
                
                return true;
            } catch (error) {
                console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
                showNotification('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return false;
            }
        }

        function isHabitDone(habitId) {
             // ì´ í•¨ìˆ˜ëŠ” ì´ì œ ì‚¬ìš©ë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤. ëŒ€ì‹  isCustomHabitDoneì„ ì‚¬ìš©
            if (habitId === 'writing') {
                const dateKey = getDateKey(state.currentDate);
                return state.habitData[dateKey]?.writing?.completed || false;
            }
            return isCustomHabitDone(habitId);
        }
        
        function isExerciseDone() {
            const dateKey = getDateKey(state.currentDate);
            const exerciseData = state.habitData[dateKey]?.exercise;
            return exerciseData && exerciseData.sessions && exerciseData.sessions.length > 0;
        }

        function getWritingStreak() {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            
            while (true) {
                const writingData = getWritingData(checkDate);
                if (writingData.completed) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function getLongestStreak() {
            let maxStreak = 0;
            let currentStreak = 0;
            
            const allDates = Object.keys(state.habitData)
                .filter(dateKey => state.habitData[dateKey].writing?.completed)
                .sort();
            
            for (let i = 0; i < allDates.length; i++) {
                if (i === 0) {
                    currentStreak = 1;
                } else {
                    const prevDate = new Date(allDates[i - 1]);
                    const currDate = new Date(allDates[i]);
                    const diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24);
                    
                    if (diffDays === 1) {
                        currentStreak++;
                    } else {
                        maxStreak = Math.max(maxStreak, currentStreak);
                        currentStreak = 1;
                    }
                }
            }
            
            return Math.max(maxStreak, currentStreak);
        }

        function getWeeklyWritingStats() {
            let totalMinutes = 0;
            let totalCharacters = 0;
            let completedDays = 0;
            const today = new Date(state.currentDate);
            
            // í˜„ì¬ ë‚ ì§œë¥¼ í¬í•¨í•˜ì—¬ 7ì¼ê°„ì˜ í†µê³„ (ì˜¤ëŠ˜ í¬í•¨ 7ì¼)
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const writingData = getWritingData(date);
                
                // ì™„ë£Œ ì¡°ê±´ì€ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆëŠ”ì§€ ì—¬ë¶€ (completed)ë¥¼ ë”°ë¦„
                if (writingData.completed) {
                    totalMinutes += writingData.totalMinutes;
                    totalCharacters += writingData.totalCharacters;
                    completedDays++;
                }
            }
            
            return {
                totalMinutes,
                totalCharacters,
                completedDays,
                averageMinutes: completedDays > 0 ? Math.round(totalMinutes / completedDays) : 0,
                averageCharacters: completedDays > 0 ? Math.round(totalCharacters / completedDays) : 0
            };
        }

        function getTotalStats() {
            let totalCharacters = 0;
            let totalMinutes = 0;
            let maxDailyCharacters = 0;
            
            Object.values(state.habitData).forEach(dayData => {
                if (dayData.writing?.sessions?.length > 0) { // ì„¸ì…˜ì´ ìˆëŠ” ëª¨ë“  ë‚ ì„ ëŒ€ìƒìœ¼ë¡œ í†µê³„ ê³„ì‚°
                    const chars = dayData.writing.totalCharacters || 0;
                    const mins = dayData.writing.totalMinutes || 0;
                    
                    totalCharacters += chars;
                    totalMinutes += mins;
                    maxDailyCharacters = Math.max(maxDailyCharacters, chars);
                }
            });
            
            return {
                totalCharacters,
                totalMinutes,
                maxDailyCharacters,
                charactersPerMinute: totalMinutes > 0 ? Math.round(totalCharacters / totalMinutes) : 0
            };
        }

        function showNotification(message, type = 'info') {
            if (type === 'error') {
                alert('ì˜¤ë¥˜: ' + message);
            } else {
                console.log(message);
            }
        }
        
        // ê¸€ì“°ê¸° ì„¸ì…˜ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            const writingData = getWritingData(state.currentDate);
            
            if (writingData.sessions.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">ì•„ì§ ì‘ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ì„¸ì…˜ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>';
                return;
            }
            
            const sortedSessions = [...writingData.sessions].sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = sortedSessions.map((session, originalIndex) => {
                const realIndex = writingData.sessions.findIndex(s => s.timestamp === session.timestamp);
                const time = formatTime(session.timestamp);
                
                return `
                    <div class="session-item flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-sm font-medium text-gray-800">${time} ì„¸ì…˜</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">${session.minutes}ë¶„</span>
                                ${session.characters > 0 ? ` Â· <span class="font-medium">${session.characters.toLocaleString()}ì</span>` : ''}
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="editSession(${realIndex})" class="text-blue-500 hover:text-blue-700 text-xs px-2 py-1 rounded" title="ìˆ˜ì •">
                                    âœï¸
                                </button>
                                <button onclick="removeSession(${realIndex})" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded" title="ì‚­ì œ">
                                    âœ•
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addSession() {
            try {
                const minutesValue = document.getElementById('sessionMinutes').value;
                const charactersValue = document.getElementById('sessionCharacters').value;
                
                const minutes = parseInt(minutesValue) || 0;
                const characters = charactersValue === '' ? 0 : parseInt(charactersValue) || 0;
                
                const errors = validateSessionInput(minutes, characters);
                if (errors.length > 0) {
                    alert(errors.join('\n'));
                    return;
                }
                
                const writingData = getWritingData(state.currentDate);
                const newSession = {
                    timestamp: Date.now(),
                    minutes: minutes,
                    characters: characters
                };
                
                writingData.sessions.push(newSession);
                writingData.totalMinutes += minutes;
                writingData.totalCharacters += characters;
                
                if (saveWritingData(state.currentDate, writingData)) {
                    document.getElementById('sessionMinutes').value = '';
                    document.getElementById('sessionCharacters').value = '';
                    
                    updateUI();
                    showNotification('ì„¸ì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
            } catch (error) {
                console.error('ì„¸ì…˜ ì¶”ê°€ ì˜¤ë¥˜:', error);
                showNotification('ì„¸ì…˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function editSession(index) {
            try {
                const writingData = getWritingData(state.currentDate);
                if (index < 0 || index >= writingData.sessions.length) return;
                
                const session = writingData.sessions[index];
                const newMinutes = prompt('ì‹œê°„ì„ ìˆ˜ì •í•˜ì„¸ìš” (ë¶„):', session.minutes);
                const newCharacters = prompt('ê¸€ì ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:', session.characters);
                
                if (newMinutes === null || newCharacters === null) return;
                
                const minutes = parseInt(newMinutes) || 0;
                const characters = parseInt(newCharacters) || 0;
                
                const errors = validateSessionInput(minutes, characters);
                if (errors.length > 0) {
                    alert(errors.join('\n'));
                    return;
                }
                
                writingData.totalMinutes = writingData.totalMinutes - session.minutes + minutes;
                writingData.totalCharacters = writingData.totalCharacters - session.characters + characters;
                
                session.minutes = minutes;
                session.characters = characters;
                
                if (saveWritingData(state.currentDate, writingData)) {
                    updateUI();
                    showNotification('ì„¸ì…˜ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
            } catch (error) {
                console.error('ì„¸ì…˜ ìˆ˜ì • ì˜¤ë¥˜:', error);
                showNotification('ì„¸ì…˜ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function removeSession(index) {
            try {
                if (!confirm('ì´ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                const writingData = getWritingData(state.currentDate);
                if (index < 0 || index >= writingData.sessions.length) return;
                
                const session = writingData.sessions[index];
                
                writingData.totalMinutes -= session.minutes;
                writingData.totalCharacters -= session.characters;
                
                writingData.sessions.splice(index, 1);
                
                // ëª©í‘œ ë‹¬ì„± ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ëœ ì´ ì‹œê°„ìœ¼ë¡œ ë‹¤ì‹œ í™•ì¸
                const currentLevel = getCurrentLevel();
                const totalMinutes = writingData.totalMinutes;
                
                if (writingData.completed && totalMinutes < currentLevel.minutes) {
                    writingData.completed = false; // ì‹œê°„ì´ ë¶€ì¡±í•´ì§€ë©´ ì™„ë£Œ ìƒíƒœ í•´ì œ
                }
                
                if (saveWritingData(state.currentDate, writingData)) {
                    checkLevelProgress();
                    updateUI();
                    showNotification('ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ì„¸ì…˜ ì‚­ì œ ì˜¤ë¥˜:', error);
                showNotification('ì„¸ì…˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function toggleDayComplete() {
            try {
                const writingData = getWritingData(state.currentDate);
                const currentLevel = getCurrentLevel();
                
                if (!writingData.completed && writingData.totalMinutes < currentLevel.minutes) {
                    alert(`ëª©í‘œ ì‹œê°„(${currentLevel.minutes}ë¶„)ì„ ë‹¬ì„±í•œ í›„ ì™„ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                
                writingData.completed = !writingData.completed;
                
                if (saveWritingData(state.currentDate, writingData)) {
                    checkLevelUp();
                    checkWeeklyGoalAndRewardFreeze(); // ë³´í˜¸ë§‰ ì¶©ì „ ì²´í¬
                    updateUI();
                    
                    if (writingData.completed) {
                        showNotification('ğŸ‰ ì˜¤ëŠ˜ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!');
                    }
                }
                
            } catch (error) {
                console.error('ì™„ë£Œ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                showNotification('ì™„ë£Œ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìš´ë™ ê¸°ë¡ í•¨ìˆ˜ë“¤
        function addExerciseSession() {
            try {
                const minutesValue = document.getElementById('exerciseMinutes').value;
                const caloriesValue = document.getElementById('exerciseCalories').value;
                
                const minutes = parseInt(minutesValue) || 0;
                const calories = parseInt(caloriesValue) || 0;
        
                if (minutes <= 0) {
                    alert('ì‹œê°„ì€ 1ë¶„ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
                if (calories < 0) {
                    alert('ì¹¼ë¡œë¦¬ëŠ” 0kcal ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
        
                const dateKey = getDateKey(state.currentDate);
                if (!state.habitData[dateKey]) {
                    state.habitData[dateKey] = {};
                }
                if (!state.habitData[dateKey].exercise) {
                    state.habitData[dateKey].exercise = { sessions: [], totalMinutes: 0, totalCalories: 0 };
                }
                
                const newSession = {
                    timestamp: Date.now(),
                    minutes: minutes,
                    calories: calories
                };
                
                state.habitData[dateKey].exercise.sessions.push(newSession);
                state.habitData[dateKey].exercise.totalMinutes += minutes;
                state.habitData[dateKey].exercise.totalCalories += calories;
        
                localStorage.setItem('habitData', JSON.stringify(state.habitData));
                
                document.getElementById('exerciseMinutes').value = '';
                document.getElementById('exerciseCalories').value = '';
                
                checkExerciseLevelUp();
                checkWeeklyGoalAndRewardFreeze(); // ë³´í˜¸ë§‰ ì¶©ì „ ì²´í¬
                updateUI();
                showNotification('ìš´ë™ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ìš´ë™ ê¸°ë¡ ì¶”ê°€ ì˜¤ë¥˜:', error);
                showNotification('ìš´ë™ ê¸°ë¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìš´ë™ ì„¸ì…˜ ì‚­ì œ
        function removeExerciseSession(timestamp) {
            try {
                if (!confirm('ì´ ìš´ë™ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const dateKey = getDateKey(state.currentDate);
                const exerciseData = state.habitData[dateKey]?.exercise;

                if (!exerciseData || !exerciseData.sessions) return;

                const index = exerciseData.sessions.findIndex(s => s.timestamp === timestamp);
                if (index === -1) return;

                const session = exerciseData.sessions[index];
                exerciseData.totalMinutes -= session.minutes;
                exerciseData.totalCalories -= session.calories;
                exerciseData.sessions.splice(index, 1);
                
                if (exerciseData.sessions.length === 0) {
                    delete state.habitData[dateKey].exercise; // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ í•„ë“œ ìì²´ë¥¼ ì‚­ì œ
                } else {
                    state.habitData[dateKey].exercise = exerciseData;
                }

                localStorage.setItem('habitData', JSON.stringify(state.habitData));

                checkExerciseLevelUp();
                updateUI();
                showNotification('ìš´ë™ ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('ìš´ë™ ì„¸ì…˜ ì‚­ì œ ì˜¤ë¥˜:', error);
                showNotification('ìš´ë™ ì„¸ì…˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function renderExerciseSessions() {
            const container = document.getElementById('exerciseSessionsContainer');
            const dateKey = getDateKey(state.currentDate);
            const exerciseData = state.habitData[dateKey]?.exercise;
            
            if (!exerciseData || !exerciseData.sessions || exerciseData.sessions.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">ì•„ì§ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const sortedSessions = [...exerciseData.sessions].sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = sortedSessions.map(session => {
                const time = formatTime(session.timestamp);
                return `
                    <div class="session-item flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm font-medium text-gray-800">${time} ì„¸ì…˜</span>
                        </div>
                        <div class="flex items-center space-x-3">
                             <div class="text-sm text-gray-600">
                                <span class="font-medium">${session.minutes}ë¶„</span>
                                Â· <span class="font-medium">${session.calories.toLocaleString()}kcal</span>
                             </div>
                            <button onclick="removeExerciseSession(${session.timestamp})" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded" title="ì‚­ì œ">
                                âœ•
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateExerciseSummary() {
            const dateKey = getDateKey(state.currentDate);
            const exerciseData = state.habitData[dateKey]?.exercise;
            const totalMinutes = exerciseData?.totalMinutes || 0;
            const totalCalories = exerciseData?.totalCalories || 0;
            
            document.getElementById('exerciseDailyTotal').textContent = 
                `${totalMinutes}ë¶„ Â· ${totalCalories.toLocaleString()}kcal`;
        }

        function getExerciseStreak() {
            let streak = 0;
            let checkDate = new Date(state.currentDate);
            
            while (true) {
                const dateKey = getDateKey(checkDate);
                const exerciseData = state.habitData[dateKey]?.exercise;
                if (exerciseData && exerciseData.sessions && exerciseData.sessions.length > 0) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }
        
        function getWeeklyExerciseStats() {
            let completedDays = 0;
            const today = new Date(state.currentDate);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = getDateKey(date);
                const exerciseData = state.habitData[dateKey]?.exercise;
                
                if (exerciseData && exerciseData.sessions && exerciseData.sessions.length > 0) {
                    completedDays++;
                }
            }
            
            return { completedDays };
        }

        function getTotalExerciseStats() {
            let totalCalories = 0;
            let totalSessions = 0;
            
            Object.values(state.habitData).forEach(dayData => {
                if (dayData.exercise && dayData.exercise.sessions) {
                    totalCalories += dayData.exercise.totalCalories || 0;
                    totalSessions += dayData.exercise.sessions.length;
                }
            });
            return { totalCalories, totalSessions };
        }

        function checkExerciseLevelUp() {
            if (state.currentExerciseLevel >= EXERCISE_LEVELS.length) return;
            
            const currentLevelData = EXERCISE_LEVELS.find(level => level.level === state.currentExerciseLevel);
            const totalStats = getTotalExerciseStats();
            
            const nextLevelData = EXERCISE_LEVELS[state.currentExerciseLevel];
            
            if (totalStats.totalSessions >= nextLevelData.required) {
                const oldLevel = state.currentExerciseLevel;
                state.currentExerciseLevel++;
                localStorage.setItem('currentExerciseLevel', state.currentExerciseLevel.toString());
                
                setTimeout(() => {
                    alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! Lv.${oldLevel} ${currentLevelData.title}ì—ì„œ Lv.${state.currentExerciseLevel}ë¡œ ë ˆë²¨ì—…í–ˆìŠµë‹ˆë‹¤!`);
                }, 500);
            }
        }
        
        // ë ˆë²¨ ì—… ì²´í¬
        function checkLevelUp() {
            const currentLevelData = getCurrentLevel();
            const streak = getWritingStreakWithFreeze(); // ë³´í˜¸ë§‰ í¬í•¨ ì—°ì†ì¼
            
            if (streak >= currentLevelData.daysRequired && state.currentLevel < WRITING_LEVELS.length) {
                const oldLevel = state.currentLevel;
                state.currentLevel++;
                state.levelProgress = 0;
                localStorage.setItem('currentLevel', state.currentLevel.toString());
                localStorage.setItem('levelProgress', '0');
                
                setTimeout(() => {
                    alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! Lv.${oldLevel} ${currentLevelData.title}ì—ì„œ Lv.${state.currentLevel}ë¡œ ë ˆë²¨ì—…í–ˆìŠµë‹ˆë‹¤!`);
                }, 500);
            } else {
                state.levelProgress = Math.min(streak, currentLevelData.daysRequired);
                localStorage.setItem('levelProgress', state.levelProgress.toString());
            }
        }

        function checkLevelProgress() {
            const currentLevelData = getCurrentLevel();
            const streak = getWritingStreakWithFreeze(); // ë³´í˜¸ë§‰ í¬í•¨ ì—°ì†ì¼
            state.levelProgress = Math.min(streak, currentLevelData.daysRequired);
            localStorage.setItem('levelProgress', state.levelProgress.toString());
        }

        // ì¼ì¼ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateDailySummary() {
            const writingData = getWritingData(state.currentDate);
            const currentLevel = getCurrentLevel();
            
            document.getElementById('dailyTotal').textContent = 
                `${writingData.totalMinutes}ë¶„ Â· ${writingData.totalCharacters.toLocaleString()}ì`;
            
            const remaining = Math.max(0, currentLevel.minutes - writingData.totalMinutes);
            if (remaining > 0) {
                document.getElementById('goalStatus').textContent = `ëª©í‘œê¹Œì§€ ${remaining}ë¶„ í•„ìš”`;
            } else {
                document.getElementById('goalStatus').textContent = 'âœ… ëª©í‘œ ë‹¬ì„±!';
            }
        }

        function updateDayCompleteButton() {
            const writingData = getWritingData(state.currentDate);
            const currentLevel = getCurrentLevel();
            const btn = document.getElementById('dayCompleteBtn');
            
            if (writingData.completed) {
                btn.className = 'w-full px-6 py-3 rounded-lg font-medium transition-all duration-200 bg-green-500 text-white';
                btn.textContent = 'âœ… ì˜¤ëŠ˜ ëª©í‘œ ì™„ë£Œë¨';
            } else if (writingData.totalMinutes >= currentLevel.minutes) {
                btn.className = 'w-full px-6 py-3 rounded-lg font-medium transition-all duration-200 bg-blue-500 text-white hover:bg-blue-600';
                btn.textContent = 'ëª©í‘œ ë‹¬ì„± ì™„ë£Œí•˜ê¸°';
            } else {
                btn.className = 'w-full px-6 py-3 rounded-lg font-medium transition-all duration-200 bg-gray-200 text-gray-600';
                btn.textContent = 'ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„± ì™„ë£Œ';
            }
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            try {
                document.getElementById('currentDateText').textContent = formatDate(state.currentDate);
                
                const currentLevelData = getCurrentLevel();
                document.getElementById('currentLevel').textContent = currentLevelData.level;
                document.getElementById('levelDescription').textContent = `${currentLevelData.title} (${currentLevelData.minutes}ë¶„)`;
                document.getElementById('levelProgress').textContent = 
                    `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${state.levelProgress}/${currentLevelData.daysRequired}ì¼`;
                
                const rawWritingProgress = (state.levelProgress / currentLevelData.daysRequired) * 100;
                const progressPercentage = Math.min(rawWritingProgress, 100);
                document.getElementById('progressBar').style.width = `${progressPercentage}%`;
                
                const currentExerciseLevelData = EXERCISE_LEVELS.find(level => level.level === state.currentExerciseLevel) || EXERCISE_LEVELS[0];
                const totalExerciseStats = getTotalExerciseStats();
                const nextExerciseRequired = (state.currentExerciseLevel < EXERCISE_LEVELS.length) ? EXERCISE_LEVELS[state.currentExerciseLevel].required : EXERCISE_LEVELS[EXERCISE_LEVELS.length - 1].required;

                const rawProgress = (totalExerciseStats.totalSessions / nextExerciseRequired) * 100;
                const progressExercisePercentage = Math.min(rawProgress, 100);

                document.getElementById('currentExerciseLevel').textContent = currentExerciseLevelData.level;
                document.getElementById('exerciseLevelDescription').textContent = `${currentExerciseLevelData.title}`;
                document.getElementById('exerciseLevelProgress').textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${totalExerciseStats.totalSessions}/${nextExerciseRequired}íšŒ`;
                document.getElementById('exerciseProgressBar').style.width = `${progressExercisePercentage}%`;

                // ë ˆë²¨ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ê¸€ì“°ê¸°)
                WRITING_LEVELS.forEach((levelData) => {
                    const levelId = levelData.level === 11 ? '11' : levelData.level;
                    const levelBox = document.getElementById(`writing-level-${levelId}`);
                    if (levelBox) {
                        if (levelData.level === state.currentLevel) {
                            levelBox.className = "p-2 bg-blue-100 rounded text-center";
                        } else {
                            levelBox.className = "p-2 bg-gray-100 rounded text-center";
                        }
                    }
                });

                // ë ˆë²¨ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ìš´ë™)
                EXERCISE_LEVELS.forEach((levelData) => {
                    const levelId = levelData.level === 6 ? '6' : levelData.level;
                    const levelBox = document.getElementById(`exercise-level-${levelId}`);
                    if (levelBox) {
                        if (levelData.level === state.currentExerciseLevel) {
                            levelBox.className = "p-2 bg-green-100 rounded text-center";
                        } else {
                            levelBox.className = "p-2 bg-gray-100 rounded text-center";
                        }
                    }
                });
                
                document.getElementById('currentTarget').textContent = `${currentLevelData.minutes}ë¶„`;
                
                renderSessions();
                updateDailySummary();
                updateDayCompleteButton();

                renderExerciseSessions();
                updateExerciseSummary();
                
                // ì—°ì†ì¼ ì—…ë°ì´íŠ¸ (ë³´í˜¸ë§‰ í¬í•¨)
                updateStreakUI();
                
                document.getElementById('novel-streak').textContent = getWritingStreak();
                document.getElementById('exercise-streak').textContent = getExerciseStreak();
                
                const weekStats = getWeeklyWritingStats();
                const totalStats = getTotalStats();
                const weeklyExerciseStats = getWeeklyExerciseStats();
                
                document.getElementById('novel-week').textContent = weekStats.completedDays;
                document.getElementById('exercise-week').textContent = weeklyExerciseStats.completedDays;
                document.getElementById('weeklyMinutes').textContent = weekStats.totalMinutes;
                document.getElementById('averageMinutes').textContent = weekStats.averageMinutes;
                document.getElementById('weeklyCharacters').textContent = weekStats.totalCharacters.toLocaleString();
                document.getElementById('averageCharacters').textContent = weekStats.averageCharacters.toLocaleString();
                
                document.getElementById('charactersPerMinute').textContent = 
                    totalStats.charactersPerMinute > 0 ? `${totalStats.charactersPerMinute}ì/ë¶„` : '-';
                document.getElementById('dailyBest').textContent = `${totalStats.maxDailyCharacters.toLocaleString()}ì`;
                document.getElementById('longestStreak').textContent = `${getLongestStreak()}ì¼`;
                document.getElementById('totalCharacters').textContent = `${totalStats.totalCharacters.toLocaleString()}ì`;
                
                
                // --- ì „ì²´ ì™„ë£Œ ìƒíƒœ ë° ë°°ì§€ ì—…ë°ì´íŠ¸ (ê¸€ì“°ê¸°, ìš´ë™, ëª¨ë“  ì»¤ìŠ¤í…€ ìŠµê´€) ---
                updateCustomHabitsInUI(); // ì´ í•¨ìˆ˜ê°€ progressTextë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

                const progressText = document.getElementById('progressText').textContent;
                const parts = progressText.match(/(\d+)\/(\d+)/);
                const totalCompleted = parseInt(parts[1]);
                const totalHabitsIncludingCustom = parseInt(parts[2]);
                
                const progressBadge = document.getElementById('progressBadge');
                if (totalCompleted === totalHabitsIncludingCustom) {
                    progressBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 animate-pulse-gentle';
                    progressBadge.textContent = 'âœ¨ ì¼ì¼ ê·¸ëœë“œ ìŠ¬ë¨! âœ¨';
                } else if (totalCompleted > 0) {
                    progressBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
                    progressBadge.textContent = 'ğŸ‘ ì˜ í•˜ê³  ìˆì–´ìš”!';
                } else {
                    progressBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';
                    progressBadge.textContent = 'ì‹œì‘í•´ë³´ì„¸ìš”!';
                }

                
                updateCoachAdvice(weekStats, totalCompleted, totalStats, weeklyExerciseStats);
                
            } catch (error) {
                console.error('UI ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                showNotification('í™”ë©´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }

        }

        function updateCoachAdvice(writingStats, completedToday, totalWritingStats, exerciseStats) {
            const advice = document.getElementById('coachAdvice');
            const hint = document.getElementById('nextLevelHint');
            
            const writingStreak = getWritingStreakWithFreeze(); // ë³´í˜¸ë§‰ í¬í•¨
            const exerciseStreak = getExerciseStreakWithFreeze(); // ë³´í˜¸ë§‰ í¬í•¨
            const totalExerciseSessions = getTotalExerciseStats().totalSessions;

            if (exerciseStats.completedDays >= 5) {
                advice.textContent = `ì´ë²ˆ ì£¼ ${exerciseStats.completedDays}íšŒ ìš´ë™ ì™„ë£Œ! ê¾¸ì¤€í•¨ì´ ì‹¬íì§€êµ¬ë ¥ì„ í‚¤ìš°ê³  ìˆì–´ìš”.`;
            } else if (exerciseStreak >= 3) {
                advice.textContent = `ğŸ”¥ ìš´ë™ ì—°ì† ${exerciseStreak}ì¼ ë‹¬ì„±! ë©‹ì§„ íë¦„ì…ë‹ˆë‹¤.`;
            } else if (totalExerciseSessions >= 20) {
                advice.textContent = `ğŸ‰ ë²Œì¨ ${totalExerciseSessions}íšŒ ìš´ë™! ë‹¹ì‹ ì˜ ê±´ê°•í•œ ìŠµê´€ì— ë°•ìˆ˜ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.`;
            }
            else if (totalWritingStats.totalCharacters > 100000) {
                advice.textContent = `ëˆ„ì  ${totalWritingStats.totalCharacters.toLocaleString()}ì ë‹¬ì„±! ì´ì œ ì§„ì§œ í”„ë¡œ ì†Œì„¤ê°€ì˜ ëª¨ìŠµì´ ë³´ì…ë‹ˆë‹¤.`;
            } else if (totalWritingStats.totalCharacters > 50000) {
                advice.textContent = `ëˆ„ì  ${totalWritingStats.totalCharacters.toLocaleString()}ì! ê¾¸ì¤€íˆ ìŒ“ì¸ ê¸€ì˜ í˜ì´ ëŒ€ë‹¨í•©ë‹ˆë‹¤.`;
            } else if (totalWritingStats.totalCharacters > 10000) {
                advice.textContent = `ëˆ„ì  ${totalWritingStats.totalCharacters.toLocaleString()}ì! ê¾¸ì¤€í•¨ì˜ ê²°ì‹¤ì´ ë³´ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.`;
            } else if (writingStreak >= 14) {
                advice.textContent = "2ì£¼ ì—°ì† ë‹¬ì„±! ì´ì œ ê¸€ì“°ê¸°ê°€ ì™„ì „íˆ ìŠµê´€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else if (writingStreak >= 7) {
                advice.textContent = "ì¼ì£¼ì¼ ì—°ì† ë‹¬ì„±! ì´ì œ ê¸€ì“°ê¸°ê°€ ìì—°ìŠ¤ëŸ¬ìš´ ìŠµê´€ì´ ë˜ì–´ê°€ê³  ìˆìŠµë‹ˆë‹¤.";
            } else if (writingStreak >= 3) {
                advice.textContent = "ì¢‹ì€ íë¦„ì´ì—ìš”! ì—°ì† ê¸°ë¡ì„ ìœ ì§€í•˜ë©´ì„œ ê¸€ ê·¼ìœ¡ì„ ë‹¨ë‹¨íˆ ë§Œë“¤ì–´ê°€ì„¸ìš”.";
            } else if (writingStats.completedDays >= 4) {
                advice.textContent = "ì´ë²ˆ ì£¼ ì˜ í•˜ê³  ìˆì–´ìš”. ê¾¸ì¤€í•¨ì´ ì¬ëŠ¥ì„ ì´ê¹ë‹ˆë‹¤.";
            } else {
                advice.textContent = "ê´œì°®ì•„ìš”. ì‘ì€ ì‹œì‘ì´ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì˜¤ëŠ˜ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ë³´ì„¸ìš”.";
            }
            
            const currentLevelData = getCurrentLevel();
            const remainingDays = currentLevelData.daysRequired - writingStreak;
            
            if (remainingDays > 0) {
                hint.textContent = `ğŸ’¡ ${remainingDays}ì¼ ë” ì—°ì†ìœ¼ë¡œ ë‹¬ì„±í•˜ë©´ ë‹¤ìŒ ë ˆë²¨ë¡œ ìŠ¹ê¸‰!`;
            } else {
                hint.textContent = "ğŸ‰ ë ˆë²¨ì—… ì¡°ê±´ ë‹¬ì„±! ê³„ì† ìœ ì§€í•˜ë©´ ìŠ¹ê¸‰í•©ë‹ˆë‹¤!";
            }
        }


        // ë‚ ì§œ ë³€ê²½
        function changeDate(days) {
            const newDate = new Date(state.currentDate);
            newDate.setDate(newDate.getDate() + days);
            state.currentDate = newDate;
            updateUI();
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            try {
                const exportData = {
                    habitData: state.habitData,
                    currentLevel: state.currentLevel,
                    levelProgress: state.levelProgress,
                    currentExerciseLevel: state.currentExerciseLevel,
                    streakFreezes: state.streakFreezes,
                    lastFreezeUse: state.lastFreezeUse,
                    customHabits: customHabits, // ì»¤ìŠ¤í…€ ìŠµê´€ë„ í•¨ê»˜ ë‚´ë³´ë‚´ê¸°
                    exportDate: new Date().toISOString(),
                    version: '3.0' // ë²„ì „ ì—…ë°ì´íŠ¸ (ëª¨ë“  ë³´ì¡° ìŠµê´€ í†µí•©)
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                const fileName = `writing_habits_${new Date().toISOString().split('T')[0]}.json`;
                
                link.href = URL.createObjectURL(dataBlob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                showNotification('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showNotification('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let convertedCount = 0;
                    
                    if (importedData.habitData) {
                        const convertedData = {};
                        
                        Object.keys(importedData.habitData).forEach(dateKey => {
                            const dayData = importedData.habitData[dateKey];
                            convertedData[dateKey] = { ...dayData };
                            
                            // v1 ì´ì „ ë²„ì „ (novel) ë³€í™˜
                            if (dayData.novel !== undefined) {
                                convertedData[dateKey].writing = {
                                    completed: dayData.novel,
                                    sessions: dayData.novel ? [{
                                        timestamp: createTimestamp(new Date(dateKey), 9, 0),
                                        minutes: 5,
                                        characters: 0
                                    }] : [],
                                    totalMinutes: dayData.novel ? 5 : 0,
                                    totalCharacters: 0
                                };
                                delete convertedData[dateKey].novel;
                                convertedCount++;
                            }
                            // v2 ì´ì „ ë²„ì „ (writing.minutes) ë³€í™˜
                            else if (convertedData[dateKey].writing && 
                                    convertedData[dateKey].writing.minutes !== undefined && 
                                    !convertedData[dateKey].writing.sessions) {
                                
                                const writing = convertedData[dateKey].writing;
                                convertedData[dateKey].writing = {
                                    completed: writing.completed || false,
                                    sessions: writing.completed ? [{
                                        timestamp: createTimestamp(new Date(dateKey), 9, 0),
                                        minutes: writing.minutes || 0,
                                        characters: writing.characters || 0
                                    }] : [],
                                    totalMinutes: writing.minutes || 0,
                                    totalCharacters: writing.characters || 0
                                };
                                convertedCount++;
                            }
                            
                            if (convertedData[dateKey].writing) {
                                convertedData[dateKey].writing = validateAndFixWritingData(convertedData[dateKey].writing);
                            }

                            // v2 ì´ì „ ë²„ì „ (japanese, blog)ë¥¼ customHabitìœ¼ë¡œ ì˜®ê¸¸ í•„ìš” ì—†ìŒ.
                            // habitDataì—ì„œ í•´ë‹¹ í‚¤ë¥¼ ìœ ì§€í•˜ë©´ ë©ë‹ˆë‹¤.
                        });
                        
                        state.habitData = { ...state.habitData, ...convertedData };
                        localStorage.setItem('habitData', JSON.stringify(state.habitData));
                    }
                    
                    if (importedData.currentLevel) {
                        state.currentLevel = Math.max(1, Math.min(importedData.currentLevel, WRITING_LEVELS.length));
                        localStorage.setItem('currentLevel', state.currentLevel.toString());
                    }
                    
                    if (importedData.levelProgress !== undefined) {
                        state.levelProgress = Math.max(0, importedData.levelProgress);
                        localStorage.setItem('levelProgress', state.levelProgress.toString());
                    }

                    if (importedData.currentExerciseLevel) {
                        state.currentExerciseLevel = Math.max(1, Math.min(importedData.currentExerciseLevel, EXERCISE_LEVELS.length));
                        localStorage.setItem('currentExerciseLevel', state.currentExerciseLevel.toString());
                    }

                    // v2.1/v2.2/v3.0 í•„ë“œ
                    if (importedData.streakFreezes !== undefined) {
                        state.streakFreezes = Math.max(0, Math.min(importedData.streakFreezes, 5));
                        localStorage.setItem('streakFreezes', state.streakFreezes.toString());
                    }

                    if (importedData.lastFreezeUse) {
                        state.lastFreezeUse = importedData.lastFreezeUse;
                        localStorage.setItem('lastFreezeUse', state.lastFreezeUse);
                    }

                    // v2.2/v3.0 í•„ë“œ (ì»¤ìŠ¤í…€ ìŠµê´€)
                    if (importedData.customHabits) {
                        customHabits = importedData.customHabits;
                        localStorage.setItem('customHabits', JSON.stringify(customHabits));
                    } else if (importedData.version && importedData.version.startsWith('2.0')) {
                        // v2.0ì—ì„œ v3.0ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ (japanese, blog ê°•ì œ ì¶”ê°€)
                        migrateFixedHabits();
                    }
                    
                    updateUI();
                    
                    let message = 'ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!';
                    if (convertedCount > 0) {
                        message += `\n${convertedCount}ê°œì˜ ì´ì „ ê¸°ë¡ì„ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í–ˆìŠµë‹ˆë‹¤.`;
                    }
                    if (importedData.version && importedData.version.startsWith('3.0')) {
                        message += '\nëª¨ë“  ìŠµê´€ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // ì´ˆê¸°í™”
        function init() {
            console.log('ê¸€ ê·¼ìœ¡ í›ˆë ¨ì†Œ ì‹œì‘ - ëª¨ë“  ìŠµê´€ ì‚­ì œ ê°€ëŠ¥ v3.0');
            
            // v3.0: ê³ ì • ìŠµê´€ë“¤ì„ customHabitsì— í†µí•©
            migrateFixedHabits();

            try {
                updateUI();
                console.log('ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showNotification('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                addSession();
            }
        });

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(init, 100);
        });
    </script>
</body>
</html>
